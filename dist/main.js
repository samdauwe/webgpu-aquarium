!function(e){var t={};function i(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(r,s,function(t){return e[t]}.bind(null,s));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0)}([function(e,t,i){"use strict";function r(e,t){const i=[];for(let r=0;r<e;++r)i.push(t());return i}function s(e,t){if(!e){if(t=t||"Assertion failed","undefined"!=typeof Error)throw new Error(t);throw t}}i.r(t);class o{constructor(e,t,i){this._frame=e,this._op=t,this._count=i}get frame(){return this._frame}set frame(e){this._frame=e}get op(){return this._op}get count(){return this._count}}function n(e,t){var i=e.__state.conversionName.toString(),r=Math.round(e.r),s=Math.round(e.g),o=Math.round(e.b),n=e.a,a=Math.round(e.h),u=e.s.toFixed(1),h=e.v.toFixed(1);if(t||"THREE_CHAR_HEX"===i||"SIX_CHAR_HEX"===i){for(var l=e.hex.toString(16);l.length<6;)l="0"+l;return"#"+l}return"CSS_RGB"===i?"rgb("+r+","+s+","+o+")":"CSS_RGBA"===i?"rgba("+r+","+s+","+o+","+n+")":"HEX"===i?"0x"+e.hex.toString(16):"RGB_ARRAY"===i?"["+r+","+s+","+o+"]":"RGBA_ARRAY"===i?"["+r+","+s+","+o+","+n+"]":"RGB_OBJ"===i?"{r:"+r+",g:"+s+",b:"+o+"}":"RGBA_OBJ"===i?"{r:"+r+",g:"+s+",b:"+o+",a:"+n+"}":"HSV_OBJ"===i?"{h:"+a+",s:"+u+",v:"+h+"}":"HSVA_OBJ"===i?"{h:"+a+",s:"+u+",v:"+h+",a:"+n+"}":"unknown format"}var a=Array.prototype.forEach,u=Array.prototype.slice,h={BREAK:{},extend:function(e){return this.each(u.call(arguments,1),(function(t){(this.isObject(t)?Object.keys(t):[]).forEach(function(i){this.isUndefined(t[i])||(e[i]=t[i])}.bind(this))}),this),e},defaults:function(e){return this.each(u.call(arguments,1),(function(t){(this.isObject(t)?Object.keys(t):[]).forEach(function(i){this.isUndefined(e[i])&&(e[i]=t[i])}.bind(this))}),this),e},compose:function(){var e=u.call(arguments);return function(){for(var t=u.call(arguments),i=e.length-1;i>=0;i--)t=[e[i].apply(this,t)];return t[0]}},each:function(e,t,i){if(e)if(a&&e.forEach&&e.forEach===a)e.forEach(t,i);else if(e.length===e.length+0){var r,s=void 0;for(s=0,r=e.length;s<r;s++)if(s in e&&t.call(i,e[s],s)===this.BREAK)return}else for(var o in e)if(t.call(i,e[o],o)===this.BREAK)return},defer:function(e){setTimeout(e,0)},debounce:function(e,t,i){var r=void 0;return function(){var s=this,o=arguments;function n(){r=null,i||e.apply(s,o)}var a=i||!r;clearTimeout(r),r=setTimeout(n,t),a&&e.apply(s,o)}},toArray:function(e){return e.toArray?e.toArray():u.call(e)},isUndefined:function(e){return void 0===e},isNull:function(e){return null===e},isNaN:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){return isNaN(e)})),isArray:Array.isArray||function(e){return e.constructor===Array},isObject:function(e){return e===Object(e)},isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return!1===e||!0===e},isFunction:function(e){return e instanceof Function}},l=[{litmus:h.isString,conversions:{THREE_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return null!==t&&{space:"HEX",hex:parseInt("0x"+t[1].toString()+t[1].toString()+t[2].toString()+t[2].toString()+t[3].toString()+t[3].toString(),0)}},write:n},SIX_CHAR_HEX:{read:function(e){var t=e.match(/^#([A-F0-9]{6})$/i);return null!==t&&{space:"HEX",hex:parseInt("0x"+t[1].toString(),0)}},write:n},CSS_RGB:{read:function(e){var t=e.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);return null!==t&&{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3])}},write:n},CSS_RGBA:{read:function(e){var t=e.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);return null!==t&&{space:"RGB",r:parseFloat(t[1]),g:parseFloat(t[2]),b:parseFloat(t[3]),a:parseFloat(t[4])}},write:n}}},{litmus:h.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:h.isArray,conversions:{RGB_ARRAY:{read:function(e){return 3===e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return 4===e.length&&{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:h.isObject,conversions:{RGBA_OBJ:{read:function(e){return!!(h.isNumber(e.r)&&h.isNumber(e.g)&&h.isNumber(e.b)&&h.isNumber(e.a))&&{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return!!(h.isNumber(e.r)&&h.isNumber(e.g)&&h.isNumber(e.b))&&{space:"RGB",r:e.r,g:e.g,b:e.b}},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return!!(h.isNumber(e.h)&&h.isNumber(e.s)&&h.isNumber(e.v)&&h.isNumber(e.a))&&{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return!!(h.isNumber(e.h)&&h.isNumber(e.s)&&h.isNumber(e.v))&&{space:"HSV",h:e.h,s:e.s,v:e.v}},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}],f=void 0,c=void 0,d=function(){c=!1;var e=arguments.length>1?h.toArray(arguments):arguments[0];return h.each(l,(function(t){if(t.litmus(e))return h.each(t.conversions,(function(t,i){if(f=t.read(e),!1===c&&!1!==f)return c=f,f.conversionName=i,f.conversion=t,h.BREAK})),h.BREAK})),c},p=void 0,_={hsv_to_rgb:function(e,t,i){var r=Math.floor(e/60)%6,s=e/60-Math.floor(e/60),o=i*(1-t),n=i*(1-s*t),a=i*(1-(1-s)*t),u=[[i,a,o],[n,i,o],[o,i,a],[o,n,i],[a,o,i],[i,o,n]][r];return{r:255*u[0],g:255*u[1],b:255*u[2]}},rgb_to_hsv:function(e,t,i){var r=Math.min(e,t,i),s=Math.max(e,t,i),o=s-r,n=void 0;return 0===s?{h:NaN,s:0,v:0}:(n=e===s?(t-i)/o:t===s?2+(i-e)/o:4+(e-t)/o,(n/=6)<0&&(n+=1),{h:360*n,s:o/s,v:s/255})},rgb_to_hex:function(e,t,i){var r=this.hex_with_component(0,2,e);return r=this.hex_with_component(r,1,t),r=this.hex_with_component(r,0,i)},component_from_hex:function(e,t){return e>>8*t&255},hex_with_component:function(e,t,i){return i<<(p=8*t)|e&~(255<<p)}},m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},g=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},b=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),x=function e(t,i,r){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,i,r)}if("value"in s)return s.value;var n=s.get;return void 0!==n?n.call(r):void 0},S=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},y=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},v=function(){function e(){if(g(this,e),this.__state=d.apply(this,arguments),!1===this.__state)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return b(e,[{key:"toString",value:function(){return n(this)}},{key:"toHexString",value:function(){return n(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),e}();function A(e,t,i){Object.defineProperty(e,t,{get:function(){return"RGB"===this.__state.space||v.recalculateRGB(this,t,i),this.__state[t]},set:function(e){"RGB"!==this.__state.space&&(v.recalculateRGB(this,t,i),this.__state.space="RGB"),this.__state[t]=e}})}function B(e,t){Object.defineProperty(e,t,{get:function(){return"HSV"===this.__state.space||v.recalculateHSV(this),this.__state[t]},set:function(e){"HSV"!==this.__state.space&&(v.recalculateHSV(this),this.__state.space="HSV"),this.__state[t]=e}})}v.recalculateRGB=function(e,t,i){if("HEX"===e.__state.space)e.__state[t]=_.component_from_hex(e.__state.hex,i);else{if("HSV"!==e.__state.space)throw new Error("Corrupted color state");h.extend(e.__state,_.hsv_to_rgb(e.__state.h,e.__state.s,e.__state.v))}},v.recalculateHSV=function(e){var t=_.rgb_to_hsv(e.r,e.g,e.b);h.extend(e.__state,{s:t.s,v:t.v}),h.isNaN(t.h)?h.isUndefined(e.__state.h)&&(e.__state.h=0):e.__state.h=t.h},v.COMPONENTS=["r","g","b","h","s","v","hex","a"],A(v.prototype,"r",2),A(v.prototype,"g",1),A(v.prototype,"b",0),B(v.prototype,"h"),B(v.prototype,"s"),B(v.prototype,"v"),Object.defineProperty(v.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}}),Object.defineProperty(v.prototype,"hex",{get:function(){return"HEX"!==this.__state.space&&(this.__state.hex=_.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}});var E=function(){function e(t,i){g(this,e),this.initialValue=t[i],this.domElement=document.createElement("div"),this.object=t,this.property=i,this.__onChange=void 0,this.__onFinishChange=void 0}return b(e,[{key:"onChange",value:function(e){return this.__onChange=e,this}},{key:"onFinishChange",value:function(e){return this.__onFinishChange=e,this}},{key:"setValue",value:function(e){return this.object[this.property]=e,this.__onChange&&this.__onChange.call(this,e),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),e}(),P={};h.each({HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},(function(e,t){h.each(e,(function(e){P[e]=t}))}));var D=/(\d+(\.\d+)?)px/;function w(e){if("0"===e||h.isUndefined(e))return 0;var t=e.match(D);return h.isNull(t)?0:parseFloat(t[1])}var M={makeSelectable:function(e,t){void 0!==e&&void 0!==e.style&&(e.onselectstart=t?function(){return!1}:function(){},e.style.MozUserSelect=t?"auto":"none",e.style.KhtmlUserSelect=t?"auto":"none",e.unselectable=t?"on":"off")},makeFullscreen:function(e,t,i){var r=i,s=t;h.isUndefined(s)&&(s=!0),h.isUndefined(r)&&(r=!0),e.style.position="absolute",s&&(e.style.left=0,e.style.right=0),r&&(e.style.top=0,e.style.bottom=0)},fakeEvent:function(e,t,i,r){var s=i||{},o=P[t];if(!o)throw new Error("Event type "+t+" not supported.");var n=document.createEvent(o);switch(o){case"MouseEvents":var a=s.x||s.clientX||0,u=s.y||s.clientY||0;n.initMouseEvent(t,s.bubbles||!1,s.cancelable||!0,window,s.clickCount||1,0,0,a,u,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":var l=n.initKeyboardEvent||n.initKeyEvent;h.defaults(s,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),l(t,s.bubbles||!1,s.cancelable,window,s.ctrlKey,s.altKey,s.shiftKey,s.metaKey,s.keyCode,s.charCode);break;default:n.initEvent(t,s.bubbles||!1,s.cancelable||!0)}h.defaults(n,r),e.dispatchEvent(n)},bind:function(e,t,i,r){var s=r||!1;return e.addEventListener?e.addEventListener(t,i,s):e.attachEvent&&e.attachEvent("on"+t,i),M},unbind:function(e,t,i,r){var s=r||!1;return e.removeEventListener?e.removeEventListener(t,i,s):e.detachEvent&&e.detachEvent("on"+t,i),M},addClass:function(e,t){if(void 0===e.className)e.className=t;else if(e.className!==t){var i=e.className.split(/ +/);-1===i.indexOf(t)&&(i.push(t),e.className=i.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return M},removeClass:function(e,t){if(t)if(e.className===t)e.removeAttribute("class");else{var i=e.className.split(/ +/),r=i.indexOf(t);-1!==r&&(i.splice(r,1),e.className=i.join(" "))}else e.className=void 0;return M},hasClass:function(e,t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){var t=getComputedStyle(e);return w(t["border-left-width"])+w(t["border-right-width"])+w(t["padding-left"])+w(t["padding-right"])+w(t.width)},getHeight:function(e){var t=getComputedStyle(e);return w(t["border-top-width"])+w(t["border-bottom-width"])+w(t["padding-top"])+w(t["padding-bottom"])+w(t.height)},getOffset:function(e){var t=e,i={left:0,top:0};if(t.offsetParent)do{i.left+=t.offsetLeft,i.top+=t.offsetTop,t=t.offsetParent}while(t);return i},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}},L=function(e){function t(e,i){g(this,t);var r=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),s=r;return r.__prev=r.getValue(),r.__checkbox=document.createElement("input"),r.__checkbox.setAttribute("type","checkbox"),M.bind(r.__checkbox,"change",(function(){s.setValue(!s.__prev)}),!1),r.domElement.appendChild(r.__checkbox),r.updateDisplay(),r}return S(t,e),b(t,[{key:"setValue",value:function(e){var i=x(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),i}},{key:"updateDisplay",value:function(){return!0===this.getValue()?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),x(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(E),U=function(e){function t(e,i,r){g(this,t);var s=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),o=r,n=s;if(s.__select=document.createElement("select"),h.isArray(o)){var a={};h.each(o,(function(e){a[e]=e})),o=a}return h.each(o,(function(e,t){var i=document.createElement("option");i.innerHTML=t,i.setAttribute("value",e),n.__select.appendChild(i)})),s.updateDisplay(),M.bind(s.__select,"change",(function(){var e=this.options[this.selectedIndex].value;n.setValue(e)})),s.domElement.appendChild(s.__select),s}return S(t,e),b(t,[{key:"setValue",value:function(e){var i=x(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setValue",this).call(this,e);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),i}},{key:"updateDisplay",value:function(){return M.isActive(this.__select)?this:(this.__select.value=this.getValue(),x(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this))}}]),t}(E),C=function(e){function t(e,i){g(this,t);var r=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),s=r;function o(){s.setValue(s.__input.value)}return r.__input=document.createElement("input"),r.__input.setAttribute("type","text"),M.bind(r.__input,"keyup",o),M.bind(r.__input,"change",o),M.bind(r.__input,"blur",(function(){s.__onFinishChange&&s.__onFinishChange.call(s,s.getValue())})),M.bind(r.__input,"keydown",(function(e){13===e.keyCode&&this.blur()})),r.updateDisplay(),r.domElement.appendChild(r.__input),r}return S(t,e),b(t,[{key:"updateDisplay",value:function(){return M.isActive(this.__input)||(this.__input.value=this.getValue()),x(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(E);function T(e){var t=e.toString();return t.indexOf(".")>-1?t.length-t.indexOf(".")-1:0}var G=function(e){function t(e,i,r){g(this,t);var s=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),o=r||{};return s.__min=o.min,s.__max=o.max,s.__step=o.step,h.isUndefined(s.__step)?0===s.initialValue?s.__impliedStep=1:s.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(s.initialValue))/Math.LN10))/10:s.__impliedStep=s.__step,s.__precision=T(s.__impliedStep),s}return S(t,e),b(t,[{key:"setValue",value:function(e){var i=e;return void 0!==this.__min&&i<this.__min?i=this.__min:void 0!==this.__max&&i>this.__max&&(i=this.__max),void 0!==this.__step&&i%this.__step!=0&&(i=Math.round(i/this.__step)*this.__step),x(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setValue",this).call(this,i)}},{key:"min",value:function(e){return this.__min=e,this}},{key:"max",value:function(e){return this.__max=e,this}},{key:"step",value:function(e){return this.__step=e,this.__impliedStep=e,this.__precision=T(e),this}}]),t}(E);var F=function(e){function t(e,i,r){g(this,t);var s=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,r));s.__truncationSuspended=!1;var o=s,n=void 0;function a(){o.__onFinishChange&&o.__onFinishChange.call(o,o.getValue())}function u(e){var t=n-e.clientY;o.setValue(o.getValue()+t*o.__impliedStep),n=e.clientY}function l(){M.unbind(window,"mousemove",u),M.unbind(window,"mouseup",l),a()}return s.__input=document.createElement("input"),s.__input.setAttribute("type","text"),M.bind(s.__input,"change",(function(){var e=parseFloat(o.__input.value);h.isNaN(e)||o.setValue(e)})),M.bind(s.__input,"blur",(function(){a()})),M.bind(s.__input,"mousedown",(function(e){M.bind(window,"mousemove",u),M.bind(window,"mouseup",l),n=e.clientY})),M.bind(s.__input,"keydown",(function(e){13===e.keyCode&&(o.__truncationSuspended=!0,this.blur(),o.__truncationSuspended=!1,a())})),s.updateDisplay(),s.domElement.appendChild(s.__input),s}return S(t,e),b(t,[{key:"updateDisplay",value:function(){var e,i,r;return this.__input.value=this.__truncationSuspended?this.getValue():(e=this.getValue(),i=this.__precision,r=Math.pow(10,i),Math.round(e*r)/r),x(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(G);function O(e,t,i,r,s){return r+(e-t)/(i-t)*(s-r)}var N=function(e){function t(e,i,r,s,o){g(this,t);var n=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,{min:r,max:s,step:o})),a=n;function u(e){e.preventDefault();var t=a.__background.getBoundingClientRect();return a.setValue(O(e.clientX,t.left,t.right,a.__min,a.__max)),!1}function h(){M.unbind(window,"mousemove",u),M.unbind(window,"mouseup",h),a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())}function l(e){var t=e.touches[0].clientX,i=a.__background.getBoundingClientRect();a.setValue(O(t,i.left,i.right,a.__min,a.__max))}function f(){M.unbind(window,"touchmove",l),M.unbind(window,"touchend",f),a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())}return n.__background=document.createElement("div"),n.__foreground=document.createElement("div"),M.bind(n.__background,"mousedown",(function(e){document.activeElement.blur(),M.bind(window,"mousemove",u),M.bind(window,"mouseup",h),u(e)})),M.bind(n.__background,"touchstart",(function(e){if(1!==e.touches.length)return;M.bind(window,"touchmove",l),M.bind(window,"touchend",f),l(e)})),M.addClass(n.__background,"slider"),M.addClass(n.__foreground,"slider-fg"),n.updateDisplay(),n.__background.appendChild(n.__foreground),n.domElement.appendChild(n.__background),n}return S(t,e),b(t,[{key:"updateDisplay",value:function(){var e=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=100*e+"%",x(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"updateDisplay",this).call(this)}}]),t}(G),R=function(e){function t(e,i,r){g(this,t);var s=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i)),o=s;return s.__button=document.createElement("div"),s.__button.innerHTML=void 0===r?"Fire":r,M.bind(s.__button,"click",(function(e){return e.preventDefault(),o.fire(),!1})),M.addClass(s.__button,"button"),s.domElement.appendChild(s.__button),s}return S(t,e),b(t,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),t}(E),I=function(e){function t(e,i){g(this,t);var r=y(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));r.__color=new v(r.getValue()),r.__temp=new v(0);var s=r;r.domElement=document.createElement("div"),M.makeSelectable(r.domElement,!1),r.__selector=document.createElement("div"),r.__selector.className="selector",r.__saturation_field=document.createElement("div"),r.__saturation_field.className="saturation-field",r.__field_knob=document.createElement("div"),r.__field_knob.className="field-knob",r.__field_knob_border="2px solid ",r.__hue_knob=document.createElement("div"),r.__hue_knob.className="hue-knob",r.__hue_field=document.createElement("div"),r.__hue_field.className="hue-field",r.__input=document.createElement("input"),r.__input.type="text",r.__input_textShadow="0 1px 1px ",M.bind(r.__input,"keydown",(function(e){13===e.keyCode&&c.call(this)})),M.bind(r.__input,"blur",c),M.bind(r.__selector,"mousedown",(function(){M.addClass(this,"drag").bind(window,"mouseup",(function(){M.removeClass(s.__selector,"drag")}))})),M.bind(r.__selector,"touchstart",(function(){M.addClass(this,"drag").bind(window,"touchend",(function(){M.removeClass(s.__selector,"drag")}))}));var o,n=document.createElement("div");function a(e){_(e),M.bind(window,"mousemove",_),M.bind(window,"touchmove",_),M.bind(window,"mouseup",l),M.bind(window,"touchend",l)}function u(e){m(e),M.bind(window,"mousemove",m),M.bind(window,"touchmove",m),M.bind(window,"mouseup",f),M.bind(window,"touchend",f)}function l(){M.unbind(window,"mousemove",_),M.unbind(window,"touchmove",_),M.unbind(window,"mouseup",l),M.unbind(window,"touchend",l),p()}function f(){M.unbind(window,"mousemove",m),M.unbind(window,"touchmove",m),M.unbind(window,"mouseup",f),M.unbind(window,"touchend",f),p()}function c(){var e=d(this.value);!1!==e?(s.__color.__state=e,s.setValue(s.__color.toOriginal())):this.value=s.__color.toString()}function p(){s.__onFinishChange&&s.__onFinishChange.call(s,s.__color.toOriginal())}function _(e){-1===e.type.indexOf("touch")&&e.preventDefault();var t=s.__saturation_field.getBoundingClientRect(),i=e.touches&&e.touches[0]||e,r=i.clientX,o=i.clientY,n=(r-t.left)/(t.right-t.left),a=1-(o-t.top)/(t.bottom-t.top);return a>1?a=1:a<0&&(a=0),n>1?n=1:n<0&&(n=0),s.__color.v=a,s.__color.s=n,s.setValue(s.__color.toOriginal()),!1}function m(e){-1===e.type.indexOf("touch")&&e.preventDefault();var t=s.__hue_field.getBoundingClientRect(),i=1-((e.touches&&e.touches[0]||e).clientY-t.top)/(t.bottom-t.top);return i>1?i=1:i<0&&(i=0),s.__color.h=360*i,s.setValue(s.__color.toOriginal()),!1}return h.extend(r.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),h.extend(r.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:r.__field_knob_border+(r.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),h.extend(r.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),h.extend(r.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),h.extend(n.style,{width:"100%",height:"100%",background:"none"}),V(n,"top","rgba(0,0,0,0)","#000"),h.extend(r.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),(o=r.__hue_field).style.background="",o.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",o.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",o.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",o.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",o.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",h.extend(r.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:r.__input_textShadow+"rgba(0,0,0,0.7)"}),M.bind(r.__saturation_field,"mousedown",a),M.bind(r.__saturation_field,"touchstart",a),M.bind(r.__field_knob,"mousedown",a),M.bind(r.__field_knob,"touchstart",a),M.bind(r.__hue_field,"mousedown",u),M.bind(r.__hue_field,"touchstart",u),r.__saturation_field.appendChild(n),r.__selector.appendChild(r.__field_knob),r.__selector.appendChild(r.__saturation_field),r.__selector.appendChild(r.__hue_field),r.__hue_field.appendChild(r.__hue_knob),r.domElement.appendChild(r.__input),r.domElement.appendChild(r.__selector),r.updateDisplay(),r}return S(t,e),b(t,[{key:"updateDisplay",value:function(){var e=d(this.getValue());if(!1!==e){var t=!1;h.each(v.COMPONENTS,(function(i){if(!h.isUndefined(e[i])&&!h.isUndefined(this.__color.__state[i])&&e[i]!==this.__color.__state[i])return t=!0,{}}),this),t&&h.extend(this.__color.__state,e)}h.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var i=this.__color.v<.5||this.__color.s>.5?255:0,r=255-i;h.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+i+","+i+","+i+")"}),this.__hue_knob.style.marginTop=100*(1-this.__color.h/360)+"px",this.__temp.s=1,this.__temp.v=1,V(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),h.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+i+","+i+","+i+")",textShadow:this.__input_textShadow+"rgba("+r+","+r+","+r+",.7)"})}}]),t}(E),k=["-moz-","-o-","-webkit-","-ms-",""];function V(e,t,i,r){e.style.background="",h.each(k,(function(s){e.style.cssText+="background: "+s+"linear-gradient("+t+", "+i+" 0%, "+r+" 100%); "}))}var W=function(e,t){var i=t||document,r=document.createElement("style");r.type="text/css",r.innerHTML=e;var s=i.getElementsByTagName("head")[0];try{s.appendChild(r)}catch(e){}},H='<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n\n    </div>\n\n  </div>\n\n</div>',z=function(e,t){var i=e[t];return h.isArray(arguments[2])||h.isObject(arguments[2])?new U(e,t,arguments[2]):h.isNumber(i)?h.isNumber(arguments[2])&&h.isNumber(arguments[3])?h.isNumber(arguments[4])?new N(e,t,arguments[2],arguments[3],arguments[4]):new N(e,t,arguments[2],arguments[3]):h.isNumber(arguments[4])?new F(e,t,{min:arguments[2],max:arguments[3],step:arguments[4]}):new F(e,t,{min:arguments[2],max:arguments[3]}):h.isString(i)?new C(e,t):h.isFunction(i)?new R(e,t,""):h.isBoolean(i)?new L(e,t):null};var j=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){setTimeout(e,1e3/60)},Y=function(){function e(){g(this,e),this.backgroundElement=document.createElement("div"),h.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),M.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),h.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var t=this;M.bind(this.backgroundElement,"click",(function(){t.hide()}))}return b(e,[{key:"show",value:function(){var e=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),h.defer((function(){e.backgroundElement.style.opacity=1,e.domElement.style.opacity=1,e.domElement.style.webkitTransform="scale(1)"}))}},{key:"hide",value:function(){var e=this,t=function t(){e.domElement.style.display="none",e.backgroundElement.style.display="none",M.unbind(e.domElement,"webkitTransitionEnd",t),M.unbind(e.domElement,"transitionend",t),M.unbind(e.domElement,"oTransitionEnd",t)};M.bind(this.domElement,"webkitTransitionEnd",t),M.bind(this.domElement,"transitionend",t),M.bind(this.domElement,"oTransitionEnd",t),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-M.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-M.getHeight(this.domElement)/2+"px"}}]),e}();W(function(e){if(e&&"undefined"!=typeof window){var t=document.createElement("style");return t.setAttribute("type","text/css"),t.innerHTML=e,document.head.appendChild(t),e}}(".dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}\n"));var X=function(){try{return!!window.localStorage}catch(e){return!1}}(),q=void 0,K=!0,J=void 0,Q=!1,Z=[],$=function e(t){var i=this,r=t||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),M.addClass(this.domElement,"dg"),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],r=h.defaults(r,{closeOnTop:!1,autoPlace:!0,width:e.DEFAULT_WIDTH}),r=h.defaults(r,{resizable:r.autoPlace,hideable:r.autoPlace}),h.isUndefined(r.load)?r.load={preset:"Default"}:r.preset&&(r.load.preset=r.preset),h.isUndefined(r.parent)&&r.hideable&&Z.push(this),r.resizable=h.isUndefined(r.parent)&&r.resizable,r.autoPlace&&h.isUndefined(r.scrollable)&&(r.scrollable=!0);var s,o=X&&"true"===localStorage.getItem(oe(this,"isLocal")),n=void 0,a=void 0;if(Object.defineProperties(this,{parent:{get:function(){return r.parent}},scrollable:{get:function(){return r.scrollable}},autoPlace:{get:function(){return r.autoPlace}},closeOnTop:{get:function(){return r.closeOnTop}},preset:{get:function(){return i.parent?i.getRoot().preset:r.load.preset},set:function(e){i.parent?i.getRoot().preset=e:r.load.preset=e,function(e){for(var t=0;t<e.__preset_select.length;t++)e.__preset_select[t].value===e.preset&&(e.__preset_select.selectedIndex=t)}(this),i.revert()}},width:{get:function(){return r.width},set:function(e){r.width=e,le(i,e)}},name:{get:function(){return r.name},set:function(e){r.name=e,a&&(a.innerHTML=r.name)}},closed:{get:function(){return r.closed},set:function(t){r.closed=t,r.closed?M.addClass(i.__ul,e.CLASS_CLOSED):M.removeClass(i.__ul,e.CLASS_CLOSED),this.onResize(),i.__closeButton&&(i.__closeButton.innerHTML=t?e.TEXT_OPEN:e.TEXT_CLOSED)}},load:{get:function(){return r.load}},useLocalStorage:{get:function(){return o},set:function(e){X&&(o=e,e?M.bind(window,"unload",n):M.unbind(window,"unload",n),localStorage.setItem(oe(i,"isLocal"),e))}}}),h.isUndefined(r.parent)){if(this.closed=r.closed||!1,M.addClass(this.domElement,e.CLASS_MAIN),M.makeSelectable(this.domElement,!1),X&&o){i.useLocalStorage=!0;var u=localStorage.getItem(oe(this,"gui"));u&&(r.load=JSON.parse(u))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=e.TEXT_CLOSED,M.addClass(this.__closeButton,e.CLASS_CLOSE_BUTTON),r.closeOnTop?(M.addClass(this.__closeButton,e.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(M.addClass(this.__closeButton,e.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),M.bind(this.__closeButton,"click",(function(){i.closed=!i.closed}))}else{void 0===r.closed&&(r.closed=!0);var l=document.createTextNode(r.name);M.addClass(l,"controller-name"),a=ee(i,l);M.addClass(this.__ul,e.CLASS_CLOSED),M.addClass(a,"title"),M.bind(a,"click",(function(e){return e.preventDefault(),i.closed=!i.closed,!1})),r.closed||(this.closed=!1)}r.autoPlace&&(h.isUndefined(r.parent)&&(K&&(J=document.createElement("div"),M.addClass(J,"dg"),M.addClass(J,e.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(J),K=!1),J.appendChild(this.domElement),M.addClass(this.domElement,e.CLASS_AUTO_PLACE)),this.parent||le(i,r.width)),this.__resizeHandler=function(){i.onResizeDebounced()},M.bind(window,"resize",this.__resizeHandler),M.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),M.bind(this.__ul,"transitionend",this.__resizeHandler),M.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),r.resizable&&he(this),n=function(){X&&"true"===localStorage.getItem(oe(i,"isLocal"))&&localStorage.setItem(oe(i,"gui"),JSON.stringify(i.getSaveObject()))},this.saveToLocalStorageIfPossible=n,r.parent||((s=i.getRoot()).width+=1,h.defer((function(){s.width-=1})))};function ee(e,t,i){var r=document.createElement("li");return t&&r.appendChild(t),i?e.__ul.insertBefore(r,i):e.__ul.appendChild(r),e.onResize(),r}function te(e){M.unbind(window,"resize",e.__resizeHandler),e.saveToLocalStorageIfPossible&&M.unbind(window,"unload",e.saveToLocalStorageIfPossible)}function ie(e,t){var i=e.__preset_select[e.__preset_select.selectedIndex];i.innerHTML=t?i.value+"*":i.value}function re(e,t){var i=e.getRoot(),r=i.__rememberedObjects.indexOf(t.object);if(-1!==r){var s=i.__rememberedObjectIndecesToControllers[r];if(void 0===s&&(s={},i.__rememberedObjectIndecesToControllers[r]=s),s[t.property]=t,i.load&&i.load.remembered){var o=i.load.remembered,n=void 0;if(o[e.preset])n=o[e.preset];else{if(!o.Default)return;n=o.Default}if(n[r]&&void 0!==n[r][t.property]){var a=n[r][t.property];t.initialValue=a,t.setValue(a)}}}}function se(e,t,i,r){if(void 0===t[i])throw new Error('Object "'+t+'" has no property "'+i+'"');var s=void 0;if(r.color)s=new I(t,i);else{var o=[t,i].concat(r.factoryArgs);s=z.apply(e,o)}r.before instanceof E&&(r.before=r.before.__li),re(e,s),M.addClass(s.domElement,"c");var n=document.createElement("span");M.addClass(n,"property-name"),n.innerHTML=s.property;var a=document.createElement("div");a.appendChild(n),a.appendChild(s.domElement);var u=ee(e,a,r.before);return M.addClass(u,$.CLASS_CONTROLLER_ROW),s instanceof I?M.addClass(u,"color"):M.addClass(u,m(s.getValue())),function(e,t,i){if(i.__li=t,i.__gui=e,h.extend(i,{options:function(t){if(arguments.length>1){var r=i.__li.nextElementSibling;return i.remove(),se(e,i.object,i.property,{before:r,factoryArgs:[h.toArray(arguments)]})}if(h.isArray(t)||h.isObject(t)){var s=i.__li.nextElementSibling;return i.remove(),se(e,i.object,i.property,{before:s,factoryArgs:[t]})}},name:function(e){return i.__li.firstElementChild.firstElementChild.innerHTML=e,i},listen:function(){return i.__gui.listen(i),i},remove:function(){return i.__gui.remove(i),i}}),i instanceof N){var r=new F(i.object,i.property,{min:i.__min,max:i.__max,step:i.__step});h.each(["updateDisplay","onChange","onFinishChange","step","min","max"],(function(e){var t=i[e],s=r[e];i[e]=r[e]=function(){var e=Array.prototype.slice.call(arguments);return s.apply(r,e),t.apply(i,e)}})),M.addClass(t,"has-slider"),i.domElement.insertBefore(r.domElement,i.domElement.firstElementChild)}else if(i instanceof F){var s=function(t){if(h.isNumber(i.__min)&&h.isNumber(i.__max)){var r=i.__li.firstElementChild.firstElementChild.innerHTML,s=i.__gui.__listening.indexOf(i)>-1;i.remove();var o=se(e,i.object,i.property,{before:i.__li.nextElementSibling,factoryArgs:[i.__min,i.__max,i.__step]});return o.name(r),s&&o.listen(),o}return t};i.min=h.compose(s,i.min),i.max=h.compose(s,i.max)}else i instanceof L?(M.bind(t,"click",(function(){M.fakeEvent(i.__checkbox,"click")})),M.bind(i.__checkbox,"click",(function(e){e.stopPropagation()}))):i instanceof R?(M.bind(t,"click",(function(){M.fakeEvent(i.__button,"click")})),M.bind(t,"mouseover",(function(){M.addClass(i.__button,"hover")})),M.bind(t,"mouseout",(function(){M.removeClass(i.__button,"hover")}))):i instanceof I&&(M.addClass(t,"color"),i.updateDisplay=h.compose((function(e){return t.style.borderLeftColor=i.__color.toString(),e}),i.updateDisplay),i.updateDisplay());i.setValue=h.compose((function(t){return e.getRoot().__preset_select&&i.isModified()&&ie(e.getRoot(),!0),t}),i.setValue)}(e,u,s),e.__controllers.push(s),s}function oe(e,t){return document.location.href+"."+t}function ne(e,t,i){var r=document.createElement("option");r.innerHTML=t,r.value=t,e.__preset_select.appendChild(r),i&&(e.__preset_select.selectedIndex=e.__preset_select.length-1)}function ae(e,t){t.style.display=e.useLocalStorage?"block":"none"}function ue(e){var t=e.__save_row=document.createElement("li");M.addClass(e.domElement,"has-save"),e.__ul.insertBefore(t,e.__ul.firstChild),M.addClass(t,"save-row");var i=document.createElement("span");i.innerHTML="&nbsp;",M.addClass(i,"button gears");var r=document.createElement("span");r.innerHTML="Save",M.addClass(r,"button"),M.addClass(r,"save");var s=document.createElement("span");s.innerHTML="New",M.addClass(s,"button"),M.addClass(s,"save-as");var o=document.createElement("span");o.innerHTML="Revert",M.addClass(o,"button"),M.addClass(o,"revert");var n=e.__preset_select=document.createElement("select");if(e.load&&e.load.remembered?h.each(e.load.remembered,(function(t,i){ne(e,i,i===e.preset)})):ne(e,"Default",!1),M.bind(n,"change",(function(){for(var t=0;t<e.__preset_select.length;t++)e.__preset_select[t].innerHTML=e.__preset_select[t].value;e.preset=this.value})),t.appendChild(n),t.appendChild(i),t.appendChild(r),t.appendChild(s),t.appendChild(o),X){var a=document.getElementById("dg-local-explain"),u=document.getElementById("dg-local-storage");document.getElementById("dg-save-locally").style.display="block","true"===localStorage.getItem(oe(0,"isLocal"))&&u.setAttribute("checked","checked"),ae(e,a),M.bind(u,"change",(function(){e.useLocalStorage=!e.useLocalStorage,ae(e,a)}))}var l=document.getElementById("dg-new-constructor");M.bind(l,"keydown",(function(e){!e.metaKey||67!==e.which&&67!==e.keyCode||q.hide()})),M.bind(i,"click",(function(){l.innerHTML=JSON.stringify(e.getSaveObject(),void 0,2),q.show(),l.focus(),l.select()})),M.bind(r,"click",(function(){e.save()})),M.bind(s,"click",(function(){var t=prompt("Enter a new preset name.");t&&e.saveAs(t)})),M.bind(o,"click",(function(){e.revert()}))}function he(e){var t=void 0;function i(i){return i.preventDefault(),e.width+=t-i.clientX,e.onResize(),t=i.clientX,!1}function r(){M.removeClass(e.__closeButton,$.CLASS_DRAG),M.unbind(window,"mousemove",i),M.unbind(window,"mouseup",r)}function s(s){return s.preventDefault(),t=s.clientX,M.addClass(e.__closeButton,$.CLASS_DRAG),M.bind(window,"mousemove",i),M.bind(window,"mouseup",r),!1}e.__resize_handle=document.createElement("div"),h.extend(e.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"}),M.bind(e.__resize_handle,"mousedown",s),M.bind(e.__closeButton,"mousedown",s),e.domElement.insertBefore(e.__resize_handle,e.domElement.firstElementChild)}function le(e,t){e.domElement.style.width=t+"px",e.__save_row&&e.autoPlace&&(e.__save_row.style.width=t+"px"),e.__closeButton&&(e.__closeButton.style.width=t+"px")}function fe(e,t){var i={};return h.each(e.__rememberedObjects,(function(r,s){var o={},n=e.__rememberedObjectIndecesToControllers[s];h.each(n,(function(e,i){o[i]=t?e.initialValue:e.getValue()})),i[s]=o})),i}$.toggleHide=function(){Q=!Q,h.each(Z,(function(e){e.domElement.style.display=Q?"none":""}))},$.CLASS_AUTO_PLACE="a",$.CLASS_AUTO_PLACE_CONTAINER="ac",$.CLASS_MAIN="main",$.CLASS_CONTROLLER_ROW="cr",$.CLASS_TOO_TALL="taller-than-window",$.CLASS_CLOSED="closed",$.CLASS_CLOSE_BUTTON="close-button",$.CLASS_CLOSE_TOP="close-top",$.CLASS_CLOSE_BOTTOM="close-bottom",$.CLASS_DRAG="drag",$.DEFAULT_WIDTH=245,$.TEXT_CLOSED="Close Controls",$.TEXT_OPEN="Open Controls",$._keydownHandler=function(e){"text"===document.activeElement.type||72!==e.which&&72!==e.keyCode||$.toggleHide()},M.bind(window,"keydown",$._keydownHandler,!1),h.extend($.prototype,{add:function(e,t){return se(this,e,t,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,t){return se(this,e,t,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var t=this;h.defer((function(){t.onResize()}))},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&J.removeChild(this.domElement);var e=this;h.each(this.__folders,(function(t){e.removeFolder(t)})),M.unbind(window,"keydown",$._keydownHandler,!1),te(this)},addFolder:function(e){if(void 0!==this.__folders[e])throw new Error('You already have a folder in this GUI by the name "'+e+'"');var t={name:e,parent:this};t.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(t.closed=this.load.folders[e].closed,t.load=this.load.folders[e]);var i=new $(t);this.__folders[e]=i;var r=ee(this,i.domElement);return M.addClass(r,"folder"),i},removeFolder:function(e){this.__ul.removeChild(e.domElement.parentElement),delete this.__folders[e.name],this.load&&this.load.folders&&this.load.folders[e.name]&&delete this.load.folders[e.name],te(e);var t=this;h.each(e.__folders,(function(t){e.removeFolder(t)})),h.defer((function(){t.onResize()}))},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var e=this.getRoot();if(e.scrollable){var t=M.getOffset(e.__ul).top,i=0;h.each(e.__ul.childNodes,(function(t){e.autoPlace&&t===e.__save_row||(i+=M.getHeight(t))})),window.innerHeight-t-20<i?(M.addClass(e.domElement,$.CLASS_TOO_TALL),e.__ul.style.height=window.innerHeight-t-20+"px"):(M.removeClass(e.domElement,$.CLASS_TOO_TALL),e.__ul.style.height="auto")}e.__resize_handle&&h.defer((function(){e.__resize_handle.style.height=e.__ul.offsetHeight+"px"})),e.__closeButton&&(e.__closeButton.style.width=e.width+"px")},onResizeDebounced:h.debounce((function(){this.onResize()}),50),remember:function(){if(h.isUndefined(q)&&((q=new Y).domElement.innerHTML=H),this.parent)throw new Error("You can only call remember on a top level GUI.");var e=this;h.each(Array.prototype.slice.call(arguments),(function(t){0===e.__rememberedObjects.length&&ue(e),-1===e.__rememberedObjects.indexOf(t)&&e.__rememberedObjects.push(t)})),this.autoPlace&&le(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var e=this.load;return e.closed=this.closed,this.__rememberedObjects.length>0&&(e.preset=this.preset,e.remembered||(e.remembered={}),e.remembered[this.preset]=fe(this)),e.folders={},h.each(this.__folders,(function(t,i){e.folders[i]=t.getSaveObject()})),e},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=fe(this),ie(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered.Default=fe(this,!0)),this.load.remembered[e]=fe(this),this.preset=e,ne(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(e){h.each(this.__controllers,(function(t){this.getRoot().load.remembered?re(e||this.getRoot(),t):t.setValue(t.initialValue),t.__onFinishChange&&t.__onFinishChange.call(t,t.getValue())}),this),h.each(this.__folders,(function(e){e.revert(e)})),e||ie(this.getRoot(),!1)},listen:function(e){var t=0===this.__listening.length;this.__listening.push(e),t&&function e(t){0!==t.length&&j.call(window,(function(){e(t)}));h.each(t,(function(e){e.updateDisplay()}))}(this.__listening)},updateDisplay:function(){h.each(this.__controllers,(function(e){e.updateDisplay()})),h.each(this.__folders,(function(e){e.updateDisplay()}))}});var ce=$;class de{constructor(e,t,i,r,s){if(this._stride=0,this._offset=0,this._size=0,this._usage=s?GPUBufferUsage.INDEX:GPUBufferUsage.VERTEX,this._totalComponents=t,r instanceof Float32Array){const t=r.BYTES_PER_ELEMENT;this._size=i*t;const s=t*r.length;this._buf=e.createBuffer(s,this._usage|GPUBufferUsage.COPY_DST),e.setBufferData(this._buf,0,s,r)}else if(r instanceof Uint16Array){const t=r.BYTES_PER_ELEMENT;if(this._size=i*t,this._totalComponents%2!=0){r=function(e,t){if(!e&&!t)throw"Please specify valid arguments for parameters a and b.";if(!t||0===t.length)return e;if(!e||0===e.length)return t;if(Object.prototype.toString.call(e)!==Object.prototype.toString.call(t))throw"The types of the two arguments passed for parameters a and b do not match.";let i=new e.constructor(e.length+t.length);return i.set(e),i.set(t,e.length),i}(r,new Uint16Array([0]))}const s=t*r.length;this._buf=e.createBuffer(s,this._usage|GPUBufferUsage.COPY_DST),e.setBufferData(this._buf,0,s,r)}}dispose(){this._buf=null}get buffer(){return this._buf}get totalComponents(){return this._totalComponents}get stride(){return this._stride}get offset(){return this._offset}get usageBit(){return this._usage}get dataSize(){return this._size}}class pe extends class{constructor(e){this._head=0,this._tail=0,this._size=0,this._tail=e,this._size=e}dispose(){}get size(){return this._size}get availableSize(){return this._size-this._tail}reset(e){return!1}flush(){}destroy(){}allocate(e){return 0}}{constructor(e,t){super(t),this.bufferManager=null,this.bufferManager=e,this.reset(t)}set mappedData(e){this._bufferMappedResultBuffer=e[0],this._pixels=e[1]}push(e,t,i,r,s,o){return(s instanceof Uint16Array?new Uint16Array(this._pixels):new Float32Array(this._pixels)).set(s),e.copyBufferToBuffer(this._bufferMappedResultBuffer,i,t,r,o),!0}reset(e){if(e>this.size)return!1;this._head=0,this._tail=0;let[t,i]=this.bufferManager.context.createBufferMapped(GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,e);return this._bufferMappedResultBuffer=t,this._pixels=i,!0}static MapWriteCallback(e,t){s(null!==e,"Invalid data in MapWriteCallback function."),t.mappedData=e,t.bufferManager.mappedBufferList.push(t)}flush(){this._head=0,this._tail=0,this._bufferMappedResultBuffer.unmap()}destroy(){this._bufferMappedResultBuffer=null}reMap(){this._bufferMappedResultBuffer.mapWriteAsync().then(e=>{pe.MapWriteCallback([this._bufferMappedResultBuffer,e],this)})}allocate(e){return this._tail+=e,s(this._tail<this._size,"Unable to allocate the requested memory size."),this._tail-e}}class _e{constructor(){this.mappedBufferList=new Array,this._enqueuedBufferList=new Array,this._bufferPoolSize=_e.BUFFER_POOL_MAX_SIZE}dispose(){this.destroyBufferPool()}get size(){return this._bufferPoolSize}resetBuffer(e,t){if(-1===this._find(e))return!1;const i=e.size;return!!e.reset(t)&&(this._usedSize=this._usedSize-i+t,!0)}destroyBuffer(e){const t=this._find(e);return-1!==t&&(this._usedSize-=e.size,e.destroy(),this._enqueuedBufferList.splice(t,1),!0)}_find(e){return this._enqueuedBufferList.length>0?this._enqueuedBufferList.indexOf(e):-1}destroyBufferPool(){}flush(){for(let e of this._enqueuedBufferList)e.flush()}allocate(e,t){return null}}_e.BUFFER_POOL_MAX_SIZE=4096e5,_e.BUFFER_MAX_COUNT=10,_e.BUFFER_PER_ALLOCATE_SIZE=_e.BUFFER_POOL_MAX_SIZE/_e.BUFFER_MAX_COUNT;class me extends _e{constructor(e,t){super(),this.context=null,this.context=e,this.sync=t,this.encoder=e.createCommandEncoder()}dispose(){this.encoder=null}allocate(e,t){let i=null,r=0;if(this.sync){if(this._usedSize+e>this._bufferPoolSize)return{buffer:i,offset:t};i=new pe(this,e),this._enqueuedBufferList.push(i)}else{for(;this.mappedBufferList.length>0&&(i=this.mappedBufferList[0],i.availableSize<e);)this.mappedBufferList.shift(),i=null;if(null==i)if(this._count<_e.BUFFER_MAX_COUNT)this._usedSize+=e,i=new pe(this,_e.BUFFER_PER_ALLOCATE_SIZE),this.mappedBufferList.push(i),this._count++;else{if(!(this.mappedBufferList.length+this._enqueuedBufferList.length<this._count))return null;for(;0===this.mappedBufferList.length;)this.context.waitABit();i=this.mappedBufferList[0],i.availableSize<e&&(this.mappedBufferList.shift(),i=null)}0!==this._enqueuedBufferList.length&&this._enqueuedBufferList[this._enqueuedBufferList.length-1]==i||this._enqueuedBufferList.push(i),r=i.allocate(e),t=r}return{buffer:i,offset:t}}flush(){this.mappedBufferList.length>0&&this._enqueuedBufferList[this._enqueuedBufferList.length-1]===this.mappedBufferList[0]&&this.mappedBufferList.shift();for(let e of this._enqueuedBufferList)e.flush();const e=this.encoder.finish();if(this.context.queue.submit([e]),this.sync){for(let e=0;e<this._enqueuedBufferList.length;++e){this._enqueuedBufferList[e].dispose()}this._usedSize=0}else for(let e=0;e<this._enqueuedBufferList.length;++e){this._enqueuedBufferList[e].reMap()}this._enqueuedBufferList.length=0,this.encoder=this.context.createCommandEncoder()}destroyBufferPool(){if(this.sync){for(let e of this._enqueuedBufferList)e.destroy();this._enqueuedBufferList.length=0}}}var ge=function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function n(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,a)}u((r=r.apply(e,t||[])).next())}))};let be=void 0;class xe{constructor(){this.worldPosition=r(xe.kWorldPosition,()=>0),this.nextPosition=r(xe.kNextPosition,()=>0)}static toArray(e){let t=[];for(let i=0;i<e.length;++i)t=t.concat(e[i].getAsArray());return t}getAsArray(){return this.worldPosition.concat(this.scale,this.nextPosition,this.time)}static offsetof(e){let t=0;switch(e){case"worldPosition":t=0;break;case"scale":t=xe.kWorldPosition;break;case"nextPosition":t=xe.kWorldPosition+1;break;case"time":t=xe.kWorldPosition+1+xe.kNextPosition}return 4*t}get data(){return new Float32Array(this.getAsArray())}static get byteSize(){return 4*(xe.kWorldPosition+1+xe.kNextPosition+1)}}xe.kWorldPosition=3,xe.kNextPosition=3;class Se{constructor(){this.worldPosition=r(Se.kWorldPosition,()=>0),this.nextPosition=r(Se.kNextPosition,()=>0),this.padding=r(Se.kPadding,()=>0)}getAsArray(){return this.worldPosition.concat(this.scale,this.nextPosition,this.time,this.padding)}get data(){return new Float32Array(this.getAsArray())}static get byteSize(){return 4*(xe.kWorldPosition+1+xe.kNextPosition+1+Se.kPadding)}}Se.kWorldPosition=3,Se.kNextPosition=3,Se.kPadding=56;class ye{constructor(){this.uniforms=r(ye.kUniforms,()=>0)}get fishLength(){return this.uniforms[0]}set fishLength(e){this.uniforms[0]=e}get fishWaveLength(){return this.uniforms[1]}set fishWaveLength(e){this.uniforms[1]=e}get fishBendAmount(){return this.uniforms[2]}set fishBendAmount(e){this.uniforms[2]=e}get data(){return new Float32Array(this.uniforms)}static get byteSize(){return 4*ye.kUniforms}}ye.kUniforms=3;class ve{constructor(){this.uniforms=r(ve.kUniforms,()=>0)}get fogPower(){return this.uniforms[0]}set fogPower(e){this.uniforms[0]=e}get fogMult(){return this.uniforms[1]}set fogMult(e){this.uniforms[1]=e}get fogOffset(){return this.uniforms[2]}set fogOffset(e){this.uniforms[2]=e}get padding(){return this.uniforms[3]}set padding(e){this.uniforms[3]=e}get fogColor(){return this.uniforms.slice(4)}set fogColor(e){this.uniforms[4]=e[0],this.uniforms[5]=e[1],this.uniforms[6]=e[2],this.uniforms[7]=e[3]}get data(){return new Float32Array(this.uniforms)}static get byteSize(){return 4*ve.kUniforms}}ve.kUniforms=8;class Ae{constructor(){this.uniforms=r(Ae.kUniforms,()=>0)}get eta(){return this.uniforms[0]}set eta(e){this.uniforms[0]=e}get tankColorFudge(){return this.uniforms[1]}set tankColorFudge(e){this.uniforms[1]=e}get refractionFudge(){return this.uniforms[2]}set refractionFudge(e){this.uniforms[2]=e}get padding(){return this.uniforms[3]}set padding(e){this.uniforms[3]=e}get data(){return new Float32Array(this.uniforms)}static get byteSize(){return 4*Ae.kUniforms}}Ae.kUniforms=4;class Be{constructor(){this.uniforms=r(Be.kUniforms,()=>0)}get shininess(){return this.uniforms[0]}set shininess(e){this.uniforms[0]=e}get specularFactor(){return this.uniforms[1]}set specularFactor(e){this.uniforms[1]=e}get data(){return new Float32Array(this.uniforms)}static get byteSize(){return 4*Be.kUniforms}}Be.kUniforms=2;class Ee{constructor(){this.lightColor=r(Ee.kLightColor,()=>0),this.specular=r(Ee.kSpecular,()=>0),this.ambient=r(Ee.kAmbient,()=>0)}getAsArray(){return this.lightColor.concat(this.specular,this.ambient)}get data(){return new Float32Array(this.getAsArray())}static get byteSize(){return 4*(Ee.kLightColor+Ee.kSpecular+Ee.kAmbient)}}Ee.kLightColor=4,Ee.kSpecular=4,Ee.kAmbient=4;class Pe{constructor(){this.lightWorldPos=r(Pe.kLightWorldPos,()=>0),this.padding=0,this.viewProjection=r(Pe.kViewProjection,()=>0),this.viewInverse=r(Pe.kViewInverse,()=>0)}getAsArray(){return this.lightWorldPos.concat(this.padding,this.viewProjection,this.viewInverse)}get data(){return new Float32Array(this.getAsArray())}static get byteSize(){return 4*(Pe.kLightWorldPos+1+Pe.kViewProjection+Pe.kViewInverse)}}Pe.kLightWorldPos=3,Pe.kViewProjection=16,Pe.kViewInverse=16;class De{constructor(){this.uniforms=r(20,()=>0)}get time(){return this.uniforms}set time(e){this.uniforms=e}get data(){return new Float32Array(this.uniforms)}get byteSize(){return 4*this.uniforms.length}}class we{constructor(){this.world=r(we.kWorld,()=>0),this.worldInverseTranspose=r(we.kWorldInverseTranspose,()=>0),this.worldViewProjection=r(we.kWorldViewProjection,()=>0)}getAsArray(){return this.world.concat(this.worldInverseTranspose,this.worldViewProjection)}get data(){return new Float32Array(this.getAsArray())}static get byteSize(){return 4*(we.kWorld+we.kWorldInverseTranspose+we.kWorldViewProjection)}clone(){const e=new we;return e.world=this.world.slice(),e.worldInverseTranspose=this.worldInverseTranspose.slice(),e.worldViewProjection=this.worldViewProjection.slice(),e}}we.kWorld=16,we.kWorldInverseTranspose=16,we.kWorldViewProjection=16;class Me{constructor(){this.worldUniforms=r(20,()=>new we)}get data(){let e=[];for(let t=0;t<this.worldUniforms.length;++t)e=e.concat(this.worldUniforms[t].getAsArray());return new Float32Array(e)}get byteSize(){return we.byteSize*this.worldUniforms.length}}class Le{constructor(e,t){this._colorAttachmentCount=0,this.cColorAttachments=r(Le.kMaxColorAttachments,()=>({}));for(let e=0;e<Le.kMaxColorAttachments;++e)this.cColorAttachments[e].attachment=void 0,this.cColorAttachments[e].storeOp="store",this.cColorAttachments[e].loadValue={r:0,g:0,b:0,a:0};this.cDepthStencilAttachmentInfo={depthLoadValue:1,depthStoreOp:"store",stencilLoadValue:0,stencilStoreOp:"store"},this._colorAttachmentCount=e.length;let i=0;for(let t of e)t&&(this.cColorAttachments[i].attachment=t),++i;this.colorAttachments=this.cColorAttachments,t?(this.cDepthStencilAttachmentInfo.attachment=t,this.depthStencilAttachment=this.cDepthStencilAttachmentInfo):this.depthStencilAttachment=void 0}set colorAttachmentCount(e){this._colorAttachmentCount=e,this.colorAttachments=this.cColorAttachments.slice(0,this._colorAttachmentCount)}}Le.kMaxColorAttachments=4;class Ue{constructor(e){this._colorStateCount=0;this.primitiveTopology="triangle-list",this.sampleCount=1,this.vertexStage={entryPoint:"main"},this.fragmentStage={entryPoint:"main"},this.cRasterizationState={frontFace:"ccw",cullMode:"none",depthBias:0,depthBiasSlopeScale:0,depthBiasClamp:0},this.rasterizationState=this.cRasterizationState;const t={srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"};this.cColorStates=r(Ue.kMaxColorAttachments,()=>({format:"rgba8unorm",alphaBlend:t,colorBlend:t,writeMask:GPUColorWrite.ALL})),this.colorStateCount=1;const i={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"keep"};this.cDepthStencilState={format:"depth24plus-stencil8",depthWriteEnabled:!1,depthCompare:"always",stencilBack:i,stencilFront:i,stencilReadMask:255,stencilWriteMask:255},this.depthStencilState=void 0}set colorStateCount(e){this._colorStateCount=e,this.colorStates=this.cColorStates.slice(0,this._colorStateCount)}}Ue.kMaxColorAttachments=4;class Ce{constructor(){this._vertexBufferCount=0;this.cVertexBuffers=r(Ce.kMaxVertexBuffers,()=>({})),this.cAttributes=r(Ce.kMaxVertexAttributes,()=>({})),this.indexFormat="uint32",this._vertexBufferCount=0;for(let e=0;e<this.cAttributes.length;++e)this.cAttributes[e]={shaderLocation:0,offset:0,format:"float"};for(let e=0;e<this.cVertexBuffers.length;++e)this.cVertexBuffers[e].arrayStride=0,this.cVertexBuffers[e].stepMode="vertex",this.cVertexBuffers[e].attributes=[];this.cVertexBuffers[0].attributes=this.cAttributes,this.vertexBuffers=this.cVertexBuffers}set vertexBufferCount(e){this._vertexBufferCount=e,this.vertexBuffers=this.cVertexBuffers.slice(0,this._vertexBufferCount)}}Ce.kMaxVertexAttributes=16,Ce.kMaxVertexBuffers=16;class Te{constructor(e,t,i){this.worldmatrices=new Array,this.textureMap={},this.bufferMap={},this._program=null,this._blend=i||!1,this._name=t||st.MODELMAX}dispose(){for(let e in this.bufferMap)null!==this.bufferMap[e]&&delete this.bufferMap[e];this.bufferMap={}}set program(e){this._program=e}prepareForDraw(){}updatePerInstanceUniforms(e){}draw(){}init(){}}class Ge extends Te{constructor(e,t,i,r){super(e,t,i),this._preInstance=0,this._curInstance=0,this._fishPerOffset=0,this._aquarium=null,this._aquarium=r}updateFishPerUniforms(e,t,i,r,s,o,n,a,u){}prepareForDraw(){this._fishPerOffset=0;for(let e=0;e<this._name-st.MODELSMALLFISHA;++e){const t=lt[e];this._fishPerOffset+=this._aquarium.fishCount[t.modelName-st.MODELSMALLFISHA]}const e=lt[this._name-st.MODELSMALLFISHA];this._curInstance=this._aquarium.fishCount[e.modelName-st.MODELSMALLFISHA]}}class Fe extends Te{constructor(e,t,i){super(e,t,i)}updateSeaweedModelTime(e){}}class Oe extends Te{constructor(e,t,i,r,s){super(i,r,s),this.diffuseTexture=null,this.normalTexture=null,this.reflectionTexture=null,this.skyboxTexture=null,this.positionBuffer=null,this.normalBuffer=null,this.texCoordBuffer=null,this.tangentBuffer=null,this.biNormalBuffer=null,this.indicesBuffer=null,this.lightFactorUniforms=new Be,this.worldUniformPer=new Me,this._vertexStateDescriptor=null,this._contextWebGPU=null,this._programWebGPU=null,this._instance=0,this._contextWebGPU=e,this._vertexStateDescriptor=new Ce,this.lightFactorUniforms.shininess=50,this.lightFactorUniforms.specularFactor=1}dispose(){this._pipeline=null,this._groupLayoutModel=null,this._groupLayoutPer=null,this._pipelineLayout=null,this._bindGroupModel=null,this._bindGroupPer=null,this._lightFactorBuffer=null,this._worldBuffer=null}init(){this._programWebGPU=this._program,this.diffuseTexture=this.textureMap.diffuse,this.normalTexture=this.textureMap.normalMap,this.reflectionTexture=this.textureMap.reflectionMap,this.skyboxTexture=this.textureMap.skybox,this.positionBuffer=this.bufferMap.position,this.normalBuffer=this.bufferMap.normal,this.texCoordBuffer=this.bufferMap.texCoord,this.tangentBuffer=this.bufferMap.tangent,this.biNormalBuffer=this.bufferMap.binormal,this.indicesBuffer=this.bufferMap.indices,this.normalTexture&&this._name!==st.MODELGLOBEBASE?(this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.cVertexBuffers[3].arrayStride=this.tangentBuffer.dataSize,this._vertexStateDescriptor.cAttributes[3].format="float3",this._vertexStateDescriptor.cAttributes[3].shaderLocation=3,this._vertexStateDescriptor.cAttributes[3].offset=0,this._vertexStateDescriptor.cVertexBuffers[3].attributes=[this._vertexStateDescriptor.cAttributes[3]],this._vertexStateDescriptor.cVertexBuffers[4].arrayStride=this.biNormalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[4].format="float3",this._vertexStateDescriptor.cAttributes[4].shaderLocation=4,this._vertexStateDescriptor.cAttributes[4].offset=0,this._vertexStateDescriptor.cVertexBuffers[4].attributes=[this._vertexStateDescriptor.cAttributes[4]],this._vertexStateDescriptor.vertexBufferCount=5,this._vertexStateDescriptor.indexFormat="uint16"):(this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.vertexBufferCount=3,this._vertexStateDescriptor.indexFormat="uint16"),this.skyboxTexture&&this.reflectionTexture&&this._name!==st.MODELGLOBEBASE?this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:4,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:5,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:6,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"cube",textureComponentType:"float"}]}):this.normalTexture&&this._name!=st.MODELGLOBEBASE?this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"}]}):this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"}]}),this._groupLayoutPer=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"}]}),this._pipelineLayout=this._contextWebGPU.makeBasicPipelineLayout({bindGroupLayouts:[this._contextWebGPU.groupLayoutGeneral,this._contextWebGPU.groupLayoutWorld,this._groupLayoutModel,this._groupLayoutPer]}),this._pipeline=this._contextWebGPU.createRenderPipeline(this._pipelineLayout,this._programWebGPU,this._vertexStateDescriptor,this._blend),this._lightFactorBuffer=this._contextWebGPU.createBufferFromData(this.lightFactorUniforms.data,Be.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._worldBuffer=this._contextWebGPU.createBufferFromData(this.worldUniformPer.data,this.worldUniformPer.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this.skyboxTexture&&this.reflectionTexture&&this._name!==st.MODELGLOBEBASE?this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:1,resource:this.reflectionTexture.sampler},{binding:2,resource:this.skyboxTexture.sampler},{binding:3,resource:this.diffuseTexture.textureView},{binding:4,resource:this.normalTexture.textureView},{binding:5,resource:this.reflectionTexture.textureView},{binding:6,resource:this.skyboxTexture.textureView}]}):this.normalTexture&&this._name!==st.MODELGLOBEBASE?this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:1,resource:this.diffuseTexture.sampler},{binding:2,resource:this.diffuseTexture.textureView},{binding:3,resource:this.normalTexture.textureView}]}):this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:1,resource:this.diffuseTexture.sampler},{binding:2,resource:this.diffuseTexture.textureView}]}),this._bindGroupPer=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutPer,entries:[{binding:0,resource:{buffer:this._worldBuffer,offset:0}}]}),this._contextWebGPU.setBufferData(this._lightFactorBuffer,0,Be.byteSize,this.lightFactorUniforms.data)}prepareForDraw(){this._contextWebGPU.updateBufferData(this._worldBuffer,this.worldUniformPer.data,this.worldUniformPer.byteSize)}draw(){const e=this._contextWebGPU.renderPass;e.setPipeline(this._pipeline),e.setBindGroup(0,this._contextWebGPU.bindGroupGeneral),e.setBindGroup(1,this._contextWebGPU.bindGroupWorld),e.setBindGroup(2,this._bindGroupModel),e.setBindGroup(3,this._bindGroupPer),e.setVertexBuffer(0,this.positionBuffer.buffer),e.setVertexBuffer(1,this.normalBuffer.buffer),e.setVertexBuffer(2,this.texCoordBuffer.buffer),this.tangentBuffer&&this.biNormalBuffer&&this._name!==st.MODELGLOBEBASE&&(e.setVertexBuffer(3,this.tangentBuffer.buffer),e.setVertexBuffer(4,this.biNormalBuffer.buffer)),e.setIndexBuffer(this.indicesBuffer.buffer,0),e.drawIndexed(this.indicesBuffer.totalComponents,this._instance,0,0,0),this._instance=0}updatePerInstanceUniforms(e){this.worldUniformPer.worldUniforms[this._instance]=e.clone(),++this._instance}}class Ne extends Oe{constructor(e,t,i,r,s){super(e,t,i,r,s),this.lightFactorUniforms.shininess=50,this.lightFactorUniforms.specularFactor=1}dispose(){super.dispose(),this._viewBuffer=null}init(){this._programWebGPU=this._program,this.diffuseTexture=this.textureMap.diffuse,this.normalTexture=this.textureMap.normalMap,this.reflectionTexture=this.textureMap.reflectionMap,this.skyboxTexture=this.textureMap.skybox,this.positionBuffer=this.bufferMap.position,this.normalBuffer=this.bufferMap.normal,this.texCoordBuffer=this.bufferMap.texCoord,this.tangentBuffer=this.bufferMap.tangent,this.biNormalBuffer=this.bufferMap.binormal,this.indicesBuffer=this.bufferMap.indices,this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.cVertexBuffers[3].arrayStride=this.tangentBuffer.dataSize,this._vertexStateDescriptor.cAttributes[3].format="float3",this._vertexStateDescriptor.cAttributes[3].shaderLocation=3,this._vertexStateDescriptor.cAttributes[3].offset=0,this._vertexStateDescriptor.cVertexBuffers[3].attributes=[this._vertexStateDescriptor.cAttributes[3]],this._vertexStateDescriptor.cVertexBuffers[4].arrayStride=this.biNormalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[4].format="float3",this._vertexStateDescriptor.cAttributes[4].shaderLocation=4,this._vertexStateDescriptor.cAttributes[4].offset=0,this._vertexStateDescriptor.cVertexBuffers[4].attributes=[this._vertexStateDescriptor.cAttributes[4]],this._vertexStateDescriptor.vertexBufferCount=5,this._vertexStateDescriptor.indexFormat="uint16",this._groupLayoutPer=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"}]}),this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture"}]}),this._pipelineLayout=this._contextWebGPU.makeBasicPipelineLayout({bindGroupLayouts:[this._contextWebGPU.groupLayoutGeneral,this._contextWebGPU.groupLayoutWorld,this._groupLayoutModel,this._groupLayoutPer]}),this._pipeline=this._contextWebGPU.createRenderPipeline(this._pipelineLayout,this._programWebGPU,this._vertexStateDescriptor,this._blend),this._lightFactorBuffer=this._contextWebGPU.createBufferFromData(this.lightFactorUniforms.data,Be.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._viewBuffer=this._contextWebGPU.createBufferFromData(this.worldUniformPer.data,20*this._contextWebGPU.calcConstantBufferByteSize(we.byteSize),GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:1,resource:this.diffuseTexture.sampler},{binding:2,resource:this.diffuseTexture.textureView}]}),this._bindGroupPer=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutPer,entries:[{binding:0,resource:{buffer:this._viewBuffer,offset:0}}]}),this._contextWebGPU.setBufferData(this._lightFactorBuffer,0,Be.byteSize,this.lightFactorUniforms.data)}prepareForDraw(){}draw(){const e=this._contextWebGPU.renderPass;e.setPipeline(this._pipeline),e.setBindGroup(0,this._contextWebGPU.bindGroupGeneral),e.setBindGroup(1,this._contextWebGPU.bindGroupWorld),e.setBindGroup(2,this._bindGroupModel),e.setBindGroup(3,this._bindGroupPer),e.setVertexBuffer(0,this.positionBuffer.buffer),e.setVertexBuffer(1,this.normalBuffer.buffer),e.setVertexBuffer(2,this.texCoordBuffer.buffer),this.tangentBuffer&&this.biNormalBuffer&&(e.setVertexBuffer(3,this.tangentBuffer.buffer),e.setVertexBuffer(4,this.biNormalBuffer.buffer)),e.setIndexBuffer(this.indicesBuffer.buffer,0),e.drawIndexed(this.indicesBuffer.totalComponents,1,0,0,0)}updatePerInstanceUniforms(e){this.worldUniformPer.worldUniforms[0]=e.clone(),this._contextWebGPU.updateBufferData(this._viewBuffer,e.data,this._contextWebGPU.calcConstantBufferByteSize(we.byteSize))}}class Re extends Oe{constructor(e,t,i,r,s){super(e,t,i,r,s),this.innerUniforms=new Ae,this.innerUniforms.eta=1,this.innerUniforms.tankColorFudge=.796,this.innerUniforms.refractionFudge=3}dispose(){super.dispose(),this._innerBuffer=null,this._viewBuffer=null}init(){this._programWebGPU=this._program,this.diffuseTexture=this.textureMap.diffuse,this.normalTexture=this.textureMap.normalMap,this.reflectionTexture=this.textureMap.reflectionMap,this.skyboxTexture=this.textureMap.skybox,this.positionBuffer=this.bufferMap.position,this.normalBuffer=this.bufferMap.normal,this.texCoordBuffer=this.bufferMap.texCoord,this.tangentBuffer=this.bufferMap.tangent,this.biNormalBuffer=this.bufferMap.binormal,this.indicesBuffer=this.bufferMap.indices,this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.cVertexBuffers[3].arrayStride=this.tangentBuffer.dataSize,this._vertexStateDescriptor.cAttributes[3].format="float3",this._vertexStateDescriptor.cAttributes[3].shaderLocation=3,this._vertexStateDescriptor.cAttributes[3].offset=0,this._vertexStateDescriptor.cVertexBuffers[3].attributes=[this._vertexStateDescriptor.cAttributes[3]],this._vertexStateDescriptor.cVertexBuffers[4].arrayStride=this.biNormalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[4].format="float3",this._vertexStateDescriptor.cAttributes[4].shaderLocation=4,this._vertexStateDescriptor.cAttributes[4].offset=0,this._vertexStateDescriptor.cVertexBuffers[4].attributes=[this._vertexStateDescriptor.cAttributes[4]],this._vertexStateDescriptor.vertexBufferCount=5,this._vertexStateDescriptor.indexFormat="uint16",this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:4,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:5,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:6,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"cube",textureComponentType:"float"}]}),this._groupLayoutPer=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"}]}),this._pipelineLayout=this._contextWebGPU.makeBasicPipelineLayout({bindGroupLayouts:[this._contextWebGPU.groupLayoutGeneral,this._contextWebGPU.groupLayoutWorld,this._groupLayoutModel,this._groupLayoutPer]}),this._pipeline=this._contextWebGPU.createRenderPipeline(this._pipelineLayout,this._programWebGPU,this._vertexStateDescriptor,this._blend),this._innerBuffer=this._contextWebGPU.createBufferFromData(this.innerUniforms.data,Ae.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._viewBuffer=this._contextWebGPU.createBufferFromData(this.worldUniformPer.data,this._contextWebGPU.calcConstantBufferByteSize(this.worldUniformPer.byteSize),GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._innerBuffer,offset:0}},{binding:1,resource:this.reflectionTexture.sampler},{binding:2,resource:this.skyboxTexture.sampler},{binding:3,resource:this.diffuseTexture.textureView},{binding:4,resource:this.normalTexture.textureView},{binding:5,resource:this.reflectionTexture.textureView},{binding:6,resource:this.skyboxTexture.textureView}]}),this._bindGroupPer=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutPer,entries:[{binding:0,resource:{buffer:this._viewBuffer,offset:0}}]}),this._contextWebGPU.setBufferData(this._innerBuffer,0,Ae.byteSize,this.innerUniforms.data)}prepareForDraw(){}draw(){const e=this._contextWebGPU.renderPass;e.setPipeline(this._pipeline),e.setBindGroup(0,this._contextWebGPU.bindGroupGeneral),e.setBindGroup(1,this._contextWebGPU.bindGroupWorld),e.setBindGroup(2,this._bindGroupModel),e.setBindGroup(3,this._bindGroupPer),e.setVertexBuffer(0,this.positionBuffer.buffer),e.setVertexBuffer(1,this.normalBuffer.buffer),e.setVertexBuffer(2,this.texCoordBuffer.buffer),e.setVertexBuffer(3,this.tangentBuffer.buffer),e.setVertexBuffer(4,this.biNormalBuffer.buffer),e.setIndexBuffer(this.indicesBuffer.buffer,0),e.drawIndexed(this.indicesBuffer.totalComponents,1,0,0,0)}updatePerInstanceUniforms(e){this.worldUniformPer.worldUniforms[0]=e.clone(),this._contextWebGPU.updateBufferData(this._viewBuffer,e.data,this._contextWebGPU.calcConstantBufferByteSize(we.byteSize))}}class Ie extends Ge{constructor(e,t,i,r,s){super(i,r,s,t),this.fishVertexUniforms=new ye,this.lightFactorUniforms=new Be,this.diffuseTexture=null,this.normalTexture=null,this.reflectionTexture=null,this.skyboxTexture=null,this.positionBuffer=null,this.normalBuffer=null,this.texCoordBuffer=null,this.tangentBuffer=null,this.biNormalBuffer=null,this.indicesBuffer=null,this._vertexStateDescriptor=null,this._contextWebGPU=e,this._vertexStateDescriptor=new Ce,this._enableDynamicBufferOffset=t.toggleBitset[at.ENABLEDYNAMICBUFFEROFFSET],this.lightFactorUniforms.shininess=5,this.lightFactorUniforms.specularFactor=.3;const o=lt[r-st.MODELSMALLFISHA];this.fishVertexUniforms.fishLength=o.fishLength,this.fishVertexUniforms.fishBendAmount=o.fishBendAmount,this.fishVertexUniforms.fishWaveLength=o.fishWaveLength,this._curInstance=this._aquarium.fishCount[o.modelName-st.MODELSMALLFISHA],this._preInstance=this._curInstance}dispose(){this._pipeline=null,this._groupLayoutModel=null,this._pipelineLayout=null,this._bindGroupModel=null,this._fishVertexBuffer=null,this._lightFactorBuffer=null}init(){this._programWebGPU=this._program,this.diffuseTexture=this.textureMap.diffuse,this.normalTexture=this.textureMap.normalMap,this.reflectionTexture=this.textureMap.reflectionMap,this.skyboxTexture=this.textureMap.skybox,this.positionBuffer=this.bufferMap.position,this.normalBuffer=this.bufferMap.normal,this.texCoordBuffer=this.bufferMap.texCoord,this.tangentBuffer=this.bufferMap.tangent,this.biNormalBuffer=this.bufferMap.binormal,this.indicesBuffer=this.bufferMap.indices,this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.cVertexBuffers[3].arrayStride=this.tangentBuffer.dataSize,this._vertexStateDescriptor.cAttributes[3].format="float3",this._vertexStateDescriptor.cAttributes[3].shaderLocation=3,this._vertexStateDescriptor.cAttributes[3].offset=0,this._vertexStateDescriptor.cVertexBuffers[3].attributes=[this._vertexStateDescriptor.cAttributes[3]],this._vertexStateDescriptor.cVertexBuffers[4].arrayStride=this.biNormalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[4].format="float3",this._vertexStateDescriptor.cAttributes[4].shaderLocation=4,this._vertexStateDescriptor.cAttributes[4].offset=0,this._vertexStateDescriptor.cVertexBuffers[4].attributes=[this._vertexStateDescriptor.cAttributes[4]],this._vertexStateDescriptor.vertexBufferCount=5,this._vertexStateDescriptor.indexFormat="uint16",this.skyboxTexture&&this.reflectionTexture?this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:4,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:5,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:6,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:7,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"cube",textureComponentType:"float"}]}):this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:4,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"}]}),this._pipelineLayout=this._contextWebGPU.makeBasicPipelineLayout({bindGroupLayouts:[this._contextWebGPU.groupLayoutGeneral,this._contextWebGPU.groupLayoutWorld,this._groupLayoutModel,this._contextWebGPU.groupLayoutFishPer]}),this._pipeline=this._contextWebGPU.createRenderPipeline(this._pipelineLayout,this._programWebGPU,this._vertexStateDescriptor,this._blend),this._fishVertexBuffer=this._contextWebGPU.createBufferFromData(this.fishVertexUniforms.data,ye.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._lightFactorBuffer=this._contextWebGPU.createBufferFromData(this.lightFactorUniforms.data,Be.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this.skyboxTexture&&this.reflectionTexture?this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._fishVertexBuffer,offset:0}},{binding:1,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:2,resource:this.reflectionTexture.sampler},{binding:3,resource:this.skyboxTexture.sampler},{binding:4,resource:this.diffuseTexture.textureView},{binding:5,resource:this.normalTexture.textureView},{binding:6,resource:this.reflectionTexture.textureView},{binding:7,resource:this.skyboxTexture.textureView}]}):this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._fishVertexBuffer,offset:0}},{binding:1,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:2,resource:this.diffuseTexture.sampler},{binding:3,resource:this.diffuseTexture.textureView},{binding:4,resource:this.normalTexture.textureView}]}),this._contextWebGPU.setBufferData(this._lightFactorBuffer,0,Be.byteSize,this.lightFactorUniforms.data),this._contextWebGPU.setBufferData(this._fishVertexBuffer,0,ye.byteSize,this.fishVertexUniforms.data)}draw(){if(0==this._curInstance)return;const e=this._contextWebGPU.renderPass;if(e.setPipeline(this._pipeline),e.setBindGroup(0,this._contextWebGPU.bindGroupGeneral),e.setBindGroup(1,this._contextWebGPU.bindGroupWorld),e.setBindGroup(2,this._bindGroupModel),e.setVertexBuffer(0,this.positionBuffer.buffer),e.setVertexBuffer(1,this.normalBuffer.buffer),e.setVertexBuffer(2,this.texCoordBuffer.buffer),e.setVertexBuffer(3,this.tangentBuffer.buffer),e.setVertexBuffer(4,this.biNormalBuffer.buffer),e.setIndexBuffer(this.indicesBuffer.buffer,0),this._enableDynamicBufferOffset)for(let t=0;t<this._curInstance;++t){const i=256*(t+this._fishPerOffset);e.setBindGroup(3,this._contextWebGPU.bindGroupFishPers[0],[i]),e.drawIndexed(this.indicesBuffer.totalComponents,1,0,0,0)}else for(let t=0;t<this._curInstance;++t)e.setBindGroup(3,this._contextWebGPU.bindGroupFishPers[t+this._fishPerOffset]),e.drawIndexed(this.indicesBuffer.totalComponents,1,0,0,0)}updatePerInstanceUniforms(e){}updateFishPerUniforms(e,t,i,r,s,o,n,a,u){u+=this._fishPerOffset,this._contextWebGPU.fishPers[u].worldPosition[0]=e,this._contextWebGPU.fishPers[u].worldPosition[1]=t,this._contextWebGPU.fishPers[u].worldPosition[2]=i,this._contextWebGPU.fishPers[u].nextPosition[0]=r,this._contextWebGPU.fishPers[u].nextPosition[1]=s,this._contextWebGPU.fishPers[u].nextPosition[2]=o,this._contextWebGPU.fishPers[u].scale=n,this._contextWebGPU.fishPers[u].time=a}}class ke extends Ge{constructor(e,t,i,s,o){super(i,s,o,t),this.fishVertexUniforms=new ye,this.lightFactorUniforms=new Be,this.fishPers=new Array,this.diffuseTexture=null,this.normalTexture=null,this.reflectionTexture=null,this.skyboxTexture=null,this.positionBuffer=null,this.normalBuffer=null,this.texCoordBuffer=null,this.tangentBuffer=null,this.biNormalBuffer=null,this.indicesBuffer=null,this._vertexStateDescriptor=null,this._programWebGPU=null,this._contextWebGPU=null,this._instance=0,this._contextWebGPU=e,this._vertexStateDescriptor=new Ce,this.lightFactorUniforms.shininess=5,this.lightFactorUniforms.specularFactor=.3;const n=lt[s-st.MODELSMALLFISHAINSTANCEDDRAWS];this.fishVertexUniforms.fishLength=n.fishLength,this.fishVertexUniforms.fishBendAmount=n.fishBendAmount,this.fishVertexUniforms.fishWaveLength=n.fishWaveLength,this._instance=t.fishCount[n.modelName-st.MODELSMALLFISHA],this.fishPers=r(this._instance,()=>new xe)}init(){0!=this._instance&&(this._programWebGPU=this._program,this.diffuseTexture=this.textureMap.diffuse,this.normalTexture=this.textureMap.normalMap,this.reflectionTexture=this.textureMap.reflectionMap,this.skyboxTexture=this.textureMap.skybox,this.positionBuffer=this.bufferMap.position,this.normalBuffer=this.bufferMap.normal,this.texCoordBuffer=this.bufferMap.texCoord,this.tangentBuffer=this.bufferMap.tangent,this.biNormalBuffer=this.bufferMap.binormal,this.indicesBuffer=this.bufferMap.indices,this._fishPersBuffer=this._contextWebGPU.createBuffer(xe.byteSize*this._instance,GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST),this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.cVertexBuffers[3].arrayStride=this.tangentBuffer.dataSize,this._vertexStateDescriptor.cAttributes[3].format="float3",this._vertexStateDescriptor.cAttributes[3].shaderLocation=3,this._vertexStateDescriptor.cAttributes[3].offset=0,this._vertexStateDescriptor.cVertexBuffers[3].attributes=[this._vertexStateDescriptor.cAttributes[3]],this._vertexStateDescriptor.cVertexBuffers[4].arrayStride=this.biNormalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[4].format="float3",this._vertexStateDescriptor.cAttributes[4].shaderLocation=4,this._vertexStateDescriptor.cAttributes[4].offset=xe.offsetof("worldPosition"),this._vertexStateDescriptor.cVertexBuffers[4].attributes=[this._vertexStateDescriptor.cAttributes[4]],this._vertexStateDescriptor.cVertexBuffers[5].arrayStride=xe.byteSize,this._vertexStateDescriptor.cAttributes[5].format="float3",this._vertexStateDescriptor.cAttributes[5].shaderLocation=5,this._vertexStateDescriptor.cAttributes[5].offset=0,this._vertexStateDescriptor.cAttributes[6].format="float",this._vertexStateDescriptor.cAttributes[6].shaderLocation=6,this._vertexStateDescriptor.cAttributes[6].offset=xe.offsetof("scale"),this._vertexStateDescriptor.cAttributes[7].format="float3",this._vertexStateDescriptor.cAttributes[7].shaderLocation=7,this._vertexStateDescriptor.cAttributes[7].offset=xe.offsetof("nextPosition"),this._vertexStateDescriptor.cAttributes[8].format="float",this._vertexStateDescriptor.cAttributes[8].shaderLocation=8,this._vertexStateDescriptor.cAttributes[8].offset=xe.offsetof("time"),this._vertexStateDescriptor.cVertexBuffers[5].attributes=this._vertexStateDescriptor.cAttributes.slice(5,9),this._vertexStateDescriptor.cVertexBuffers[5].stepMode="instance",this._vertexStateDescriptor.vertexBufferCount=6,this._vertexStateDescriptor.indexFormat="uint16",this.skyboxTexture&&this.reflectionTexture?this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:4,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:5,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:6,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:7,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"cube",textureComponentType:"float"}]}):this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:3,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"},{binding:4,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"}]}),this._groupLayoutPer=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"}]}),this._pipelineLayout=this._contextWebGPU.makeBasicPipelineLayout({bindGroupLayouts:[this._contextWebGPU.groupLayoutGeneral,this._contextWebGPU.groupLayoutWorld,this._groupLayoutModel,this._groupLayoutPer]}),this._pipeline=this._contextWebGPU.createRenderPipeline(this._pipelineLayout,this._programWebGPU,this._vertexStateDescriptor,this._blend),this._fishVertexBuffer=this._contextWebGPU.createBufferFromData(this.fishVertexUniforms.data,ye.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._lightFactorBuffer=this._contextWebGPU.createBufferFromData(this.lightFactorUniforms.data,Be.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this.skyboxTexture&&this.reflectionTexture?this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._fishVertexBuffer,offset:0}},{binding:1,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:2,resource:this.reflectionTexture.sampler},{binding:3,resource:this.skyboxTexture.sampler},{binding:4,resource:this.diffuseTexture.textureView},{binding:5,resource:this.normalTexture.textureView},{binding:6,resource:this.reflectionTexture.textureView},{binding:7,resource:this.skyboxTexture.textureView}]}):this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._fishVertexBuffer,offset:0}},{binding:1,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:2,resource:this.diffuseTexture.sampler},{binding:3,resource:this.diffuseTexture.textureView},{binding:4,resource:this.normalTexture.textureView}]}),this._contextWebGPU.setBufferData(this._lightFactorBuffer,0,Be.byteSize,this.lightFactorUniforms.data),this._contextWebGPU.setBufferData(this._fishVertexBuffer,0,ye.byteSize,this.fishVertexUniforms.data))}prepareForDraw(){}draw(){if(0==this._instance)return;this._contextWebGPU.setBufferData(this._fishPersBuffer,0,xe.byteSize*this._instance,new Float32Array(xe.toArray(this.fishPers)));const e=this._contextWebGPU.renderPass;e.setPipeline(this._pipeline),e.setBindGroup(0,this._contextWebGPU.bindGroupGeneral),e.setBindGroup(1,this._contextWebGPU.bindGroupWorld),e.setBindGroup(2,this._bindGroupModel),e.setVertexBuffer(0,this.positionBuffer.buffer),e.setVertexBuffer(1,this.normalBuffer.buffer),e.setVertexBuffer(2,this.texCoordBuffer.buffer),e.setVertexBuffer(3,this.tangentBuffer.buffer),e.setVertexBuffer(4,this.biNormalBuffer.buffer),e.setVertexBuffer(5,this._fishPersBuffer),e.setIndexBuffer(this.indicesBuffer.buffer,0),e.drawIndexed(this.indicesBuffer.totalComponents,this._instance,0,0,0)}updatePerInstanceUniforms(e){}updateFishPerUniforms(e,t,i,r,s,o,n,a,u){this.fishPers[u].worldPosition[0]=e,this.fishPers[u].worldPosition[1]=t,this.fishPers[u].worldPosition[2]=i,this.fishPers[u].nextPosition[0]=r,this.fishPers[u].nextPosition[1]=s,this.fishPers[u].nextPosition[2]=o,this.fishPers[u].scale=n,this.fishPers[u].time=a}dispose(){this._pipeline=null,this._groupLayoutModel=null,this._groupLayoutPer=null,this._pipelineLayout=null,this._bindGroupModel=null,this._bindGroupPer=null,this._fishVertexBuffer=null,this._lightFactorBuffer=null,this._fishPersBuffer=null,this.fishPers.length=0}}class Ve extends Fe{constructor(e,t,i,r,s){super(i,r,s),this.diffuseTexture=null,this.normalTexture=null,this.reflectionTexture=null,this.skyboxTexture=null,this.positionBuffer=null,this.normalBuffer=null,this.texCoordBuffer=null,this.indicesBuffer=null,this.lightFactorUniforms=new Be,this.seaweedPer=new De,this.worldUniformPer=new Me,this._vertexStateDescriptor=null,this._contextWebGPU=null,this._programWebGPU=null,this._aquarium=null,this._instance=0,this._contextWebGPU=e,this._aquarium=t,this._vertexStateDescriptor=new Ce,this.lightFactorUniforms.shininess=50,this.lightFactorUniforms.specularFactor=1}dispose(){this._pipeline=null,this._groupLayoutModel=null,this._groupLayoutPer=null,this._pipelineLayout=null,this._bindGroupModel=null,this._bindGroupPer=null,this._lightFactorBuffer=null,this._viewBuffer=null,this._timeBuffer=null}init(){this._programWebGPU=this._program,this.diffuseTexture=this.textureMap.diffuse,this.normalTexture=this.textureMap.normalMap,this.reflectionTexture=this.textureMap.reflectionMap,this.skyboxTexture=this.textureMap.skybox,this.positionBuffer=this.bufferMap.position,this.normalBuffer=this.bufferMap.normal,this.texCoordBuffer=this.bufferMap.texCoord,this.indicesBuffer=this.bufferMap.indices,this._vertexStateDescriptor.cVertexBuffers[0].arrayStride=this.positionBuffer.dataSize,this._vertexStateDescriptor.cAttributes[0].format="float3",this._vertexStateDescriptor.cAttributes[0].shaderLocation=0,this._vertexStateDescriptor.cAttributes[0].offset=0,this._vertexStateDescriptor.cVertexBuffers[0].attributes=[this._vertexStateDescriptor.cAttributes[0]],this._vertexStateDescriptor.cVertexBuffers[1].arrayStride=this.normalBuffer.dataSize,this._vertexStateDescriptor.cAttributes[1].format="float3",this._vertexStateDescriptor.cAttributes[1].shaderLocation=1,this._vertexStateDescriptor.cAttributes[1].offset=0,this._vertexStateDescriptor.cVertexBuffers[1].attributes=[this._vertexStateDescriptor.cAttributes[1]],this._vertexStateDescriptor.cVertexBuffers[2].arrayStride=this.texCoordBuffer.dataSize,this._vertexStateDescriptor.cAttributes[2].format="float2",this._vertexStateDescriptor.cAttributes[2].shaderLocation=2,this._vertexStateDescriptor.cAttributes[2].offset=0,this._vertexStateDescriptor.cVertexBuffers[2].attributes=[this._vertexStateDescriptor.cAttributes[2]],this._vertexStateDescriptor.vertexBufferCount=3,this._vertexStateDescriptor.indexFormat="uint16",this._groupLayoutModel=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:2,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture",hasDynamicOffset:!1,multisampled:!1,viewDimension:"2d",textureComponentType:"float"}]}),this._groupLayoutPer=this._contextWebGPU.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"}]}),this._pipelineLayout=this._contextWebGPU.makeBasicPipelineLayout({bindGroupLayouts:[this._contextWebGPU.groupLayoutGeneral,this._contextWebGPU.groupLayoutWorld,this._groupLayoutModel,this._groupLayoutPer]}),this._pipeline=this._contextWebGPU.createRenderPipeline(this._pipelineLayout,this._programWebGPU,this._vertexStateDescriptor,this._blend),this._lightFactorBuffer=this._contextWebGPU.createBufferFromData(this.lightFactorUniforms.data,Be.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._timeBuffer=this._contextWebGPU.createBufferFromData(this.seaweedPer.data,4*this._contextWebGPU.calcConstantBufferByteSize(this.seaweedPer.byteSize),GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._viewBuffer=this._contextWebGPU.createBufferFromData(this.worldUniformPer.data,this._contextWebGPU.calcConstantBufferByteSize(this.worldUniformPer.byteSize),GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._bindGroupModel=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutModel,entries:[{binding:0,resource:{buffer:this._lightFactorBuffer,offset:0}},{binding:1,resource:this.diffuseTexture.sampler},{binding:2,resource:this.diffuseTexture.textureView}]}),this._bindGroupPer=this._contextWebGPU.makeBindGroup({layout:this._groupLayoutPer,entries:[{binding:0,resource:{buffer:this._viewBuffer,offset:0}},{binding:1,resource:{buffer:this._timeBuffer,offset:0}}]}),this._contextWebGPU.setBufferData(this._lightFactorBuffer,0,Be.byteSize,this.lightFactorUniforms.data)}prepareForDraw(){this._contextWebGPU.updateBufferData(this._viewBuffer,this.worldUniformPer.data,this._contextWebGPU.calcConstantBufferByteSize(this.worldUniformPer.byteSize)),this._contextWebGPU.updateBufferData(this._timeBuffer,this.seaweedPer.data,this._contextWebGPU.calcConstantBufferByteSize(this.seaweedPer.byteSize))}draw(){const e=this._contextWebGPU.renderPass;e.setPipeline(this._pipeline),e.setBindGroup(0,this._contextWebGPU.bindGroupGeneral),e.setBindGroup(1,this._contextWebGPU.bindGroupWorld),e.setBindGroup(2,this._bindGroupModel),e.setBindGroup(3,this._bindGroupPer),e.setVertexBuffer(0,this.positionBuffer.buffer),e.setVertexBuffer(1,this.normalBuffer.buffer),e.setVertexBuffer(2,this.texCoordBuffer.buffer),e.setIndexBuffer(this.indicesBuffer.buffer,0),e.drawIndexed(this.indicesBuffer.totalComponents,this._instance,0,0,0),this._instance=0}updatePerInstanceUniforms(e){this.worldUniformPer.worldUniforms[this._instance]=e.clone(),this.seaweedPer.time[this._instance]=this._aquarium.g.mclock+this._instance,this._instance++}updateSeaweedModelTime(e){}}class We{static LoadTextFileSynchronous(e){const t='LoadTextFileSynchronous failed to load url "'+e+'"';let i=null;if(!window.XMLHttpRequest)throw"XMLHttpRequest is disabled";if(i=new XMLHttpRequest,i.overrideMimeType&&i.overrideMimeType("text/plain"),i.open("GET",e,!1),i.send(null),4!=i.readyState)throw t;return i.responseText}static LoadTextFile(e,t){let i=null;if(!window.XMLHttpRequest)throw"XMLHttpRequest is disabled";i=new XMLHttpRequest,i.overrideMimeType&&i.overrideMimeType("text/plain; charset=utf-8"),i.open("GET",e,!0),i.onreadystatechange=function(){if(4==i.readyState){let r="",s=200==i.status||0==i.status;s&&(r=i.responseText),t(r,s?null:"could not load: "+e)}},i.send(null)}static LoadArrayBuffer(e,t){let i=null;if(!window.XMLHttpRequest)throw"XMLHttpRequest is disabled";if(i=new XMLHttpRequest,i.open("GET",e,!0),i.onreadystatechange=function(){if(4==i.readyState){let r=void 0,s=200==i.status||0==i.status;s&&(r=i.response),t(r,s?null:"could not load: "+e)}},void 0===i.responseType)throw"no support for binary files";i.responseType="arraybuffer",i.send(null)}static LoadJSON(e,t){let i=null;if(!window.XMLHttpRequest)throw"XMLHttpRequest is disabled";i=new XMLHttpRequest,i.overrideMimeType&&i.overrideMimeType("text/plain; charset=utf-8"),i.open("GET",e,!0),i.onreadystatechange=function(){if(4==i.readyState){let r=void 0,s=200==i.status||0==i.status;if(s)try{r=JSON.parse(i.responseText)}catch(e){s=!1}t(r,s?null:"could not load: "+e)}},i.send(null)}}var He=function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function n(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,a)}u((r=r.apply(e,t||[])).next())}))};class ze extends class{constructor(e,t){e&&(this._vertexShaderCodePath=e),t&&(this._fragmentShaderCodePath=t)}get vertexShaderCode(){return this._vertexShaderCode}set vertexShaderCode(e){this._vertexShaderCode=e}get fragmentShaderCode(){return this._fragmentShaderCode}set fragmentShaderCode(e){this._fragmentShaderCode=e}dispose(){}setProgram(){}compileProgram(e,t){return He(this,void 0,void 0,(function*(){}))}loadProgram(){return He(this,void 0,void 0,(function*(){const e=new Array,t=(t,i)=>{e.push(new Promise((e,r)=>{We.LoadTextFile(t,(t,s)=>{switch(s&&(console.error("Unable to load shader: "+s),r(s)),i){case $e.Vertex:this._vertexShaderCode=t,e();break;case $e.Fragment:this._fragmentShaderCode=t,e();break;default:r("Unsupported stage: "+i)}})}))};return t(this._vertexShaderCodePath,$e.Vertex),t(this._fragmentShaderCodePath,$e.Fragment),Promise.all(e).then(()=>!0).catch(()=>(console.error("Unable to load program."),!1))}))}}{constructor(e,t,i){super(t,i),this._context=null,this._context=e}dispose(){this._vertexShaderModule=null,this._fragmentShaderModule=null,super.dispose()}compileProgram(e,t){return He(this,void 0,void 0,(function*(){return new Promise((i,r)=>{this.loadProgram().then(s=>{s?(this._fragmentShaderCode=this._fragmentShaderCode.replace(/^.*?\/\/ #noReflection$/gm,""),this._fragmentShaderCode=this._fragmentShaderCode.replace(/^.*?\/\/ #noNormalMap$/gm,""),e&&(this._fragmentShaderCode=this._fragmentShaderCode.replace(/diffuseColor.a/gm,t)),this._vertexShaderModule=this._context.createShaderModule($e.Vertex,this._vertexShaderCode),this._fragmentShaderModule=this._context.createShaderModule($e.Fragment,this._fragmentShaderCode),i()):(console.error("Unable to compile shader code."),r())})})}))}get vertexShaderModule(){return this._vertexShaderModule}get fragmentShaderModule(){return this._fragmentShaderModule}}const je=["GlobeOuter_EM_positive_x.jpg","GlobeOuter_EM_negative_x.jpg","GlobeOuter_EM_positive_y.jpg","GlobeOuter_EM_negative_y.jpg","GlobeOuter_EM_positive_z.jpg","GlobeOuter_EM_negative_z.jpg"];class Ye{constructor(e){this._path=e,this._imagePath=this._path+"../assets/",this._programPath=this._path+"../shaders/",this._propPlacementPath=this._path+"../assets/PropPlacement.js",this._fishBehaviorPath=this._path+"FishBehavior.json"}get imagePath(){return this._imagePath}get programPath(){return this._programPath}get propPlacementPath(){return this._propPlacementPath}get fishBehaviorPath(){return this._fishBehaviorPath}getSkyBoxUrls(){let e=[];for(let t=0;t<je.length;++t){const i=this._path+"../assets/"+je[t];e.push(i)}return e}getModelPath(e){return this._imagePath+e+".js"}}var Xe=function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function n(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,a)}u((r=r.apply(e,t||[])).next())}))},qe=function(){return Xe(this,void 0,void 0,(function*(){const e=yield import("https://cdnjs.cloudflare.com/ajax/libs/stats.js/r17/Stats.min.js");return yield e.default()}))},Ke=function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function n(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,a)}u((r=r.apply(e,t||[])).next())}))};class Je{constructor(e,t,i){this._width=0,this._height=0,this._name=e,this._urls=Array.isArray(t)?t:[t],this._flip=i}dispose(){}get name(){return this._name}static imageFlipY(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");i.translate(0,e.height),i.scale(1,-1),i.drawImage(e,0,0,e.width,e.height),e.src=t.toDataURL()}static loadImage(e,t){return Ke(this,void 0,void 0,(function*(){return new Promise((i,r)=>Ke(this,void 0,void 0,(function*(){let s=[];for(let i=0;i<e.length;++i){const o=new Image;try{o.src=e[i],yield o.decode(),t&&Je.imageFlipY(o)}catch(t){console.error("Unable to load image from url: "+e[i]),r(s)}s.push(o)}i(s)})))}))}resizeImage(e,t,i){const r=document.createElement("canvas");r.width=e.width,r.height=e.height;const s=r.getContext("2d");s.drawImage(e,0,0,t,i);return s.getImageData(0,0,t,i)}isPowerOf2(e){return 0==(e&e-1)}destroyImageData(e){e.length=0}loadTexture(){}getImagePixels(e){const t=document.createElement("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");this._flip&&(i.translate(0,e.height),i.scale(1,-1)),i.drawImage(e,0,0,e.width,e.height);const r=i.getImageData(0,0,e.width,e.height);let s=null;const o=256*Math.ceil(4*e.width/256);if(o==4*e.width)s=r.data;else{s=new Uint8ClampedArray(o*e.height);let t=0;for(let i=0;i<e.height;++i)for(let n=0;n<e.width;++n){let e=4*n+i*o;s[e]=r.data[t],s[e+1]=r.data[t+1],s[e+2]=r.data[t+2],s[e+3]=r.data[t+3],t+=4}}return s}}class Qe extends Je{constructor(e,t,i){super(t,Array.isArray(i)?i:[i],!Array.isArray(i)),this._context=null,this._gpuTextureHelper=null,this._textureDimension="2d",this._textureViewDimension=Array.isArray(i)?"cube":"2d",this._format="rgba8unorm",this._context=e,this._gpuTextureHelper=new Ze(e)}dispose(){this.destroyImageData(this._pixelVec),this.destroyImageData(this._resizedVec),this._textureView=null,this._texture=null,this._sampler=null}get textureDimension(){return this._textureDimension}get textureViewDimension(){return this._textureViewDimension}get textureId(){return this._texture}get sampler(){return this._sampler}get textureView(){return this._textureView}_onImageLoaded(){this._images.length>0&&(this._width=this._images[0].width,this._height=this._images[0].height,this._pixelVec=r(this._images.length,()=>null))}loadTexture(){return Ke(this,void 0,void 0,(function*(){return Promise.resolve().then(()=>Ke(this,void 0,void 0,(function*(){if(this._images=yield Je.loadImage(this._urls,this._flip),this._onImageLoaded(),"cube"===this._textureViewDimension){const e={dimension:this._textureDimension,size:{width:this._width,height:this._height,depth:6},sampleCount:1,format:this._format,mipLevelCount:1,usage:GPUTextureUsage.COPY_DST|GPUTextureUsage.SAMPLED};this._texture=this._context.createTexture(e);for(let e=0;e<6;++e){let[t,i]=this._context.createBufferMapped(GPUBufferUsage.COPY_SRC|GPUBufferUsage.MAP_WRITE,this._width*this._height*4);this._pixelVec[e]=this.getImagePixels(this._images[e]),new Uint8Array(i).set(this._pixelVec[e]),t.unmap();const r=this._context.createBufferCopyView(t,0,4*this._width,this._height),s=this._context.createTextureCopyView(this._texture,0,{x:0,y:0,z:e}),o={width:this._width,height:this._height,depth:1};this._context.commandBuffers.push(this._context.copyBufferToTexture(r,s,o))}const t={dimension:"cube",format:this._format,baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:6};this._textureView=this._texture.createView(t);let i={addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",minFilter:"linear",magFilter:"linear",mipmapFilter:"nearest"};this._sampler=this._context.createSampler(i)}else{this._texture=yield this._gpuTextureHelper.generateMipmappedTexture(this._images[0]),this._width=this._gpuTextureHelper.imageBitmapSize.width,this._height=this._gpuTextureHelper.imageBitmapSize.height;const e={dimension:"2d",format:this._format,baseMipLevel:0,mipLevelCount:Math.trunc(Math.floor(Math.log2(Math.min(this._width,this._height))))+1,baseArrayLayer:0,arrayLayerCount:1};this._textureView=this._texture.createView(e);let t={addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",minFilter:"linear",magFilter:"linear",mipmapFilter:this.isPowerOf2(this._width)&&this.isPowerOf2(this._height)?"linear":"nearest"};this._sampler=this._context.createSampler(t)}})))}))}}class Ze{constructor(e){this._context=null,this._device=null,this._context=e,this._device=this._context.device;this.mipmapSampler=this._context.createSampler({minFilter:"linear"}),this.mipmapBindGroupLayout=this._context.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"sampler"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"sampled-texture"}]}),this.mipmapPipeline=this._device.createRenderPipeline({layout:this._device.createPipelineLayout({bindGroupLayouts:[this.mipmapBindGroupLayout]}),vertexStage:{module:this._device.createShaderModule({code:this._context.glslang.compileGLSL("#version 450\n            const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));\n            const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));\n            layout(location = 0) out vec2 vTex;\n            void main() {\n            vTex = tex[gl_VertexIndex];\n            gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);\n            }\n        ","vertex")}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({code:this._context.glslang.compileGLSL("#version 450\n            layout(set = 0, binding = 0) uniform sampler imgSampler;\n            layout(set = 0, binding = 1) uniform texture2D img;\n            layout(location = 0) in vec2 vTex;\n            layout(location = 0) out vec4 outColor;\n            void main() {\n            outColor = texture(sampler2D(img, imgSampler), vTex);\n            }\n        ","fragment")}),entryPoint:"main"},primitiveTopology:"triangle-strip",colorStates:[{format:"rgba8unorm"}]})}generateMipmappedTexture(e){return Ke(this,void 0,void 0,(function*(){return new Promise((t,i)=>Ke(this,void 0,void 0,(function*(){let i=yield createImageBitmap(e,0,0,e.width,e.height);this.imageBitmapSize={width:i.width,height:i.height,depth:1};const r={width:i.width,height:i.height,depth:1},s=Math.floor(Math.log2(Math.max(i.width,i.height)))+1,o=this._device.createTexture({size:r,format:"rgba8unorm",usage:GPUTextureUsage.COPY_DST|GPUTextureUsage.SAMPLED|GPUTextureUsage.OUTPUT_ATTACHMENT,mipLevelCount:s});this._device.defaultQueue.copyImageBitmapToTexture({imageBitmap:i},{texture:o},r);const n=this._device.createTexture({size:r,format:"rgba8unorm",usage:GPUTextureUsage.COPY_SRC|GPUTextureUsage.SAMPLED|GPUTextureUsage.OUTPUT_ATTACHMENT,mipLevelCount:s}),a=this._device.createCommandEncoder({});for(let e=1;e<s;++e){a.beginRenderPass({colorAttachments:[{attachment:o.createView({baseMipLevel:e,mipLevelCount:1}),loadValue:{r:1,g:0,b:0,a:0}}]}).endPass()}for(let e=0;e<s;++e){const t=this._device.createBindGroup({layout:this.mipmapBindGroupLayout,entries:[{binding:0,resource:this.mipmapSampler},{binding:1,resource:o.createView({baseMipLevel:Math.max(0,e-1),mipLevelCount:1})}]}),i=a.beginRenderPass({colorAttachments:[{attachment:n.createView({baseMipLevel:e,mipLevelCount:1}),loadValue:"load"}]});i.setPipeline(this.mipmapPipeline),i.setBindGroup(0,t),i.draw(4,1,0,0),i.endPass(),a.copyTextureToTexture({texture:n,mipLevel:e},{texture:o,mipLevel:e},r),r.width=Math.ceil(r.width/2),r.height=Math.ceil(r.height/2)}this._device.defaultQueue.submit([a.finish()]),o.destroy(),t(n)})))}))}}var $e,et=function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function n(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,a)}u((r=r.apply(e,t||[])).next())}))};!function(e){e[e.Vertex=0]="Vertex",e[e.Fragment=1]="Fragment",e[e.Compute=2]="Compute"}($e||($e={}));class tt extends class{constructor(){this._resourceHelper=null,this._showOptionWindow=!0,this._statsIntialized=!1,this._availableToggleBitset=r(at.TOGGLEMAX,()=>!1)}get clientWidth(){return this._clientWidth}get clientHeight(){return this._clientHeight}get availableToggleBitset(){return this._availableToggleBitset}get resourceHelper(){return this._resourceHelper}statsBegin(){this._statsFPS.begin(),this._statsFrameTime.begin()}statsEnd(){this._statsFPS.end(),this._statsFrameTime.end()}initialize(e,t){return Promise.resolve().then(()=>!1)}createTextureWebGPU(e,t){return Promise.resolve().then(()=>null)}shouldQuit(){return!1}keyBoardQuit(){return!1}createBufferWebGPU(e,t,i){return null}createProgram(e,t){return null}doFlush(e){}terminate(){}flush(){}preFrame(){}updateFPS(e,t,i,r){}showFPS(e){!this._statsIntialized&&e&&this._statsFPS&&this._statsFrameTime&&(this._statsFPS.showPanel(0),this._statsFPS.domElement.style.cssText="position:absolute;top:10px;left:10px;",e.parentNode.appendChild(this._statsFPS.domElement),this._statsFrameTime.showPanel(1),this._statsFrameTime.domElement.style.cssText="position:absolute;top:10px;left:91px;",e.parentNode.appendChild(this._statsFrameTime.domElement),this._statsIntialized=!0)}reallocResource(e,t,i){}updateAllFishData(){}beginRenderPass(){}createModel(e,t,i,r){return null}initGeneralResources(e){}updateWorldlUniforms(e){}renderGUI(e,t,i,r,s){if(!this._gui){this._gui=new ce({autoPlace:!1}),this._guiSettings={Resolution:String(this._clientWidth+"x"+this.clientHeight),MSAAx4:Boolean(!!s[at.ENABLEMSAAx4]),ALPHABLENDING:Boolean(!!s[at.ENABLEALPHABLENDING]),DBO:Boolean(!!s[at.ENABLEDYNAMICBUFFEROFFSET]),INSTANCEDDRAWS:Boolean(!!s[at.ENABLEINSTANCEDDRAWS]),RENDERPASS:Boolean(!s[at.DISABLED3D12RENDERPASS]),VALIDATION:Boolean(!s[at.DISABLEWEBGPUVALIDATION]),BUFFERMAPPINGASNC:Boolean(!!s[at.BUFFERMAPPINGASYNC])},this._showOptionWindow&&(this._guiSettings.NumberOfFish=Number(i()));let t=0;for(let e in this._guiSettings){if("NumberOfFish"===String(e)){const e=i();let t=[1,1e4,2e4,3e4,5e4,1e5];t.includes(e)||(t.push(e),t.sort());var o={};for(let e=0;e<t.length;++e){const i=t[e];o[i]=i}const s=this._gui.add(this._guiSettings,"NumberOfFish",o);s.name("Number of Fish"),s.onFinishChange((function(e){r(e)}))}else{const i=this._gui.add(this._guiSettings,String(e)),r=this._guiSettings[e];"string"==typeof r||r instanceof String?i.name(String(e)+": "+String(r)):("boolean"==typeof r||r instanceof Boolean)&&i.name(String(e)+": "+String(Boolean(r)?"ON":"OFF")),i.domElement.style.pointerEvents="none",this._gui.__ul.childNodes[t++].childNodes[0].childNodes[0].classList+=" full_width"}}this._gui.domElement.style.position="absolute",this._gui.domElement.style.top="10px",this._gui.domElement.style.right="10px",e.parentNode.appendChild(this._gui.domElement)}}setWindowSize(e,t){0!==e&&(this._clientWidth=e),0!==t&&(this._clientHeight=t)}_initAvailableToggleBitset(){}}{constructor(){super(),this._hasWebGPUValidationErrors=!1,this._isSwapchainOutOfDate=!1,this._renderPassDescriptor=null,this._preferredSwapChainFormat="rgba8unorm",this._enableMSAA=!1,this._enableDynamicBufferOffset=!1,this._enableFullScreenMode=!1,this._bufferManager=null,this.commandBuffers=new Array,this.bindGroupFishPers=new Array,this.fishPers=new Array,this._resourceHelper=new Ye(document.location.toString()),this._initAvailableToggleBitset()}get glslang(){return this._glslang}dispose(){this._sceneRenderTargetView=null,this._sceneDepthStencilView=null,this._backbufferView=null,this._pipeline=null,this._bindGroup=null,this._lightWorldPositionBuffer=null,this._lightBuffer=null,this._fogBuffer=null,this._commandEncoder=null,this.commandBuffers.length=0,this._renderPass=null,this._renderPassDescriptor=null,this.groupLayoutGeneral=null,this.bindGroupGeneral=null,this.groupLayoutWorld=null,this.bindGroupWorld=null,this.groupLayoutFishPer=null,this._destroyFishResource(),this._swapChain=null,this.queue=null,this.device=null}initialize(e,t){return et(this,void 0,void 0,(function*(){return this._canvas=t,this._enableMSAA=e[at.ENABLEMSAAx4],this._disableControlPanel=e[at.DISABLECONTROLPANEL],this._enableFullScreenMode=e[at.ENABLEFULLSCREENMODE],this._syncClientSize(),new Promise((i,r)=>et(this,void 0,void 0,(function*(){try{this.adapter=yield navigator.gpu.requestAdapter(),this.device=yield this.adapter.requestDevice(),e[at.DISABLEWEBGPUVALIDATION]||"function"==typeof this.device.addEventListener&&this.device.addEventListener("uncapturederror",e=>{this._hasWebGPUValidationErrors=!0,console.error(e)}),this._glslang=yield function(){return ge(this,void 0,void 0,(function*(){if(void 0!==be)return be;const e=yield import("https://unpkg.com/@webgpu/glslang@0.0.15/dist/web-devel/glslang.js");return be=yield e.default(),be}))}(),this.queue=this.device.defaultQueue,this._gpuCanvasContext=t.getContext("gpupresent"),this._preferredSwapChainFormat=yield this._gpuCanvasContext.getSwapChainPreferredFormat(this.device),this._swapChain=this._gpuCanvasContext.configureSwapChain({device:this.device,format:this._preferredSwapChainFormat}),this._enableMSAA&&(this._sceneRenderTargetView=this.createMultisampledRenderTargetView()),this._sceneDepthStencilView=this.createDepthStencilView(),window.addEventListener("resize",this._framebufferResizeCallback),this._bufferManager=new me(this,!e[at.BUFFERMAPPINGASYNC]),this._statsFPS=yield qe(),this._statsFrameTime=yield qe()}catch(e){return r("Unable initialize the WebGPU context "+e),!1}i(!0)})))}))}_initAvailableToggleBitset(){this._availableToggleBitset[at.ENABLEMSAAx4]=!0,this._availableToggleBitset[at.ENABLEINSTANCEDDRAWS]=!1,this._availableToggleBitset[at.ENABLEDYNAMICBUFFEROFFSET]=!1,this._availableToggleBitset[at.DISCRETEGPU]=!0,this._availableToggleBitset[at.INTEGRATEDGPU]=!0,this._availableToggleBitset[at.ENABLEFULLSCREENMODE]=!0,this._availableToggleBitset[at.BUFFERMAPPINGASYNC]=!1,this._availableToggleBitset[at.TURNOFFVSYNC]=!0,this._availableToggleBitset[at.DISABLED3D12RENDERPASS]=!0,this._availableToggleBitset[at.DISABLEWEBGPUVALIDATION]=!0,this._availableToggleBitset[at.SIMULATINGFISHCOMEANDGO]=!0}_syncClientSize(){const e=this._canvas.offsetWidth*window.devicePixelRatio,t=this._canvas.offsetHeight*window.devicePixelRatio;this._enableFullScreenMode?(this._canvas.width=window.innerWidth||e,this._canvas.height=window.innerHeight||t):(this._canvas.width=e,this._canvas.height=t),this.setWindowSize(this._canvas.width,this._canvas.height)}_framebufferResizeCallback(){this._isSwapchainOutOfDate=!0}createTextureWebGPU(e,t){return Promise.resolve().then(()=>et(this,void 0,void 0,(function*(){const i=new Qe(this,e,t);return yield i.loadTexture(),i})))}shouldQuit(){return this._hasWebGPUValidationErrors}createTexture(e){return this.device.createTexture(e)}createSampler(e){return this.device.createSampler(e)}createBufferFromData(e,t,i){const r=this.createBuffer(t,i|GPUBufferUsage.COPY_DST);return this.setBufferData(r,0,t,e),r}createBufferCopyView(e,t,i,r){return{buffer:e,offset:t,bytesPerRow:i,rowsPerImage:r}}createTextureCopyView(e,t,i){return{texture:e,mipLevel:t,origin:i}}copyBufferToTexture(e,t,i){const r=this.device.createCommandEncoder();r.copyBufferToTexture(e,t,i);return r.finish()}copyBufferToBuffer(e,t,i,r,s){const o=this.device.createCommandEncoder();o.copyBufferToBuffer(e,t,i,r,s);return o.finish()}createShaderModule(e,t){const i=e==$e.Vertex?"vertex":e==$e.Fragment?"fragment":"compute";return this.device.createShaderModule({code:this._glslang.compileGLSL(t,i),source:t,transform:e=>this._glslang.compileGLSL(e,i)})}makeBindGroupLayout(e){return this.device.createBindGroupLayout(e)}makeBasicPipelineLayout(e){return this.device.createPipelineLayout(e)}createRenderPipeline(e,t,i,r){const s=t.vertexShaderModule,o=t.fragmentShaderModule,n={operation:"add",srcFactor:r?"src-alpha":"one",dstFactor:r?"one-minus-src-alpha":"zero"},a={format:this._preferredSwapChainFormat,colorBlend:n,alphaBlend:n,writeMask:GPUColorWrite.ALL},u=new Ue(this.device);u.layout=e,u.vertexStage.module=s,u.fragmentStage.module=o,u.vertexState=i,u.depthStencilState=u.cDepthStencilState,u.cDepthStencilState.format="depth24plus-stencil8",u.colorStates[0]=a,u.colorStates[0].format=this._preferredSwapChainFormat,u.cDepthStencilState.depthWriteEnabled=!0,u.cDepthStencilState.depthCompare="less",u.primitiveTopology="triangle-list",u.sampleCount=this._enableMSAA?4:1,u.rasterizationState={frontFace:"ccw",cullMode:"back",depthBias:0,depthBiasSlopeScale:0,depthBiasClamp:0};return this.device.createRenderPipeline(u)}createMultisampledRenderTargetView(){const e={dimension:"2d",size:{width:this._clientWidth,height:this._clientHeight,depth:1},sampleCount:4,format:this._preferredSwapChainFormat,mipLevelCount:1,usage:GPUTextureUsage.OUTPUT_ATTACHMENT};return this.device.createTexture(e).createView()}createDepthStencilView(){const e={dimension:"2d",size:{width:this._clientWidth,height:this._clientHeight,depth:1},sampleCount:this._enableMSAA?4:1,format:"depth24plus-stencil8",mipLevelCount:1,usage:GPUTextureUsage.OUTPUT_ATTACHMENT|GPUTextureUsage.COPY_DST};return this.device.createTexture(e).createView()}createBuffer(e,t){const i={size:e,usage:t};return this.device.createBuffer(i)}setBufferData(e,t,i,r){let[s,o]=this.createBufferMapped(GPUBufferUsage.MAP_WRITE|GPUBufferUsage.COPY_SRC,i);(r instanceof Uint16Array?new Uint16Array(o):new Float32Array(o)).set(r),s.unmap();const n=this.copyBufferToBuffer(s,0,e,0,i);this.commandBuffers.push(n)}makeBindGroup(e){return this.device.createBindGroup(e)}initGeneralResources(e){this.groupLayoutGeneral=this.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"},{binding:1,visibility:GPUShaderStage.FRAGMENT,type:"uniform-buffer"}]}),this._lightBuffer=this.createBufferFromData(e.lightUniforms.data,Ee.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this._fogBuffer=this.createBufferFromData(e.fogUniforms.data,ve.byteSize,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this.bindGroupGeneral=this.makeBindGroup({layout:this.groupLayoutGeneral,entries:[{binding:0,resource:{buffer:this._lightBuffer,offset:0}},{binding:1,resource:{buffer:this._fogBuffer,offset:0}}]}),this.setBufferData(this._lightBuffer,0,Ee.byteSize,e.lightUniforms.data),this.setBufferData(this._fogBuffer,0,ve.byteSize,e.fogUniforms.data),this.groupLayoutWorld=this.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer"}]}),this._lightWorldPositionBuffer=this.createBufferFromData(e.lightWorldPositionUniform.data,this.calcConstantBufferByteSize(Pe.byteSize),GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),this.bindGroupWorld=this.makeBindGroup({layout:this.groupLayoutWorld,entries:[{binding:0,resource:{buffer:this._lightWorldPositionBuffer,offset:0}}]});const t=e.toggleBitset[at.ENABLEDYNAMICBUFFEROFFSET];this.groupLayoutFishPer=this.makeBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,type:"uniform-buffer",hasDynamicOffset:!!t||void 0}]}),this.reallocResource(e.preFishCount,e.curFishCount,t)}updateWorldlUniforms(e){this.updateBufferData(this._lightWorldPositionBuffer,e.lightWorldPositionUniform.data,this.calcConstantBufferByteSize(Pe.byteSize))}createBufferWebGPU(e,t,i){return new de(this,t.length,e,t,i)}createProgram(e,t){return new ze(this,e,t)}doFlush(e){this._renderPass.endPass(),this._bufferManager.flush();const t=this._commandEncoder.finish();this.commandBuffers.push(t),this.flush()}flush(){this.queue.submit(this.commandBuffers),this.commandBuffers.length=0}preFrame(){this._isSwapchainOutOfDate&&(this._syncClientSize(),this._enableMSAA&&(this._sceneRenderTargetView=this.createMultisampledRenderTargetView()),this._sceneDepthStencilView=this.createDepthStencilView(),this._isSwapchainOutOfDate=!1),this._commandEncoder=this.device.createCommandEncoder(),this._backbufferView=this._swapChain.getCurrentTexture().createView(),this._enableMSAA?(this._renderPassDescriptor=new Le([this._sceneRenderTargetView],this._sceneDepthStencilView),this._renderPassDescriptor.cColorAttachments[0].resolveTarget=this._backbufferView,this._renderPassDescriptor.cColorAttachments[0].storeOp="clear",this._renderPassDescriptor.cColorAttachments[0].loadValue={r:0,g:.8,b:1,a:0},this._renderPassDescriptor.colorAttachmentCount=1):(this._renderPassDescriptor=new Le([this._backbufferView],this._sceneDepthStencilView),this._renderPassDescriptor.cColorAttachments[0].storeOp="store",this._renderPassDescriptor.cColorAttachments[0].loadValue={r:0,g:.8,b:1,a:0},this._renderPassDescriptor.colorAttachmentCount=1),this._renderPass=this._commandEncoder.beginRenderPass(this._renderPassDescriptor)}updateFPS(e,t,i,r){this._disableControlPanel||this.renderGUI(this._canvas,e,t,i,r)}showFPS(e){this._disableControlPanel||super.showFPS(this._canvas)}createModel(e,t,i,r){let s=null;switch(t){case ot.FISH:s=new Ie(this,e,t,i,r);break;case ot.FISHINSTANCEDDRAW:s=new ke(this,e,t,i,r);break;case ot.GENERIC:s=new Oe(this,e,t,i,r);break;case ot.INNER:s=new Re(this,e,t,i,r);break;case ot.SEAWEED:s=new Ve(this,e,t,i,r);break;case ot.OUTSIDE:s=new Ne(this,e,t,i,r);break;default:s=null,console.error("Can not create model type: "+t)}return s}reallocResource(e,t,i){if(this._preTotalInstance=e,this._curTotalInstance=t,this._enableDynamicBufferOffset=i,0===t)return;if(e>=t)return;this._destroyFishResource(),this.fishPers=r(t,()=>new Se),this.bindGroupFishPers=i?Array.from([null]):r(t,()=>null);const s=this.calcConstantBufferByteSize(Se.byteSize*t);if(this.fishPersBuffer=this.createBuffer(s,GPUBufferUsage.COPY_DST|GPUBufferUsage.UNIFORM),i)this.bindGroupFishPers[0]=this.makeBindGroup({layout:this.groupLayoutFishPer,entries:[{binding:0,resource:{buffer:this.fishPersBuffer,offset:0}}]});else for(let e=0;e<t;++e)this.bindGroupFishPers[e]=this.makeBindGroup({layout:this.groupLayoutFishPer,entries:[{binding:0,resource:{buffer:this.fishPersBuffer,offset:this.calcConstantBufferByteSize(Se.byteSize*e)}}]})}createBufferMapped(e,t){const i={size:t,usage:e},r=this.device.createBufferMapped(i);return s(r[1].byteLength===t,"Invalid buffer size."),r}get renderPass(){return this._renderPass}waitABit(){}createCommandEncoder(){return this.device.createCommandEncoder()}updateAllFishData(){const e=this.calcConstantBufferByteSize(Se.byteSize*this._curTotalInstance);let t=[];for(let e=0;e<this._curTotalInstance;++e)t=t.concat(this.fishPers[e].getAsArray());this.updateBufferData(this.fishPersBuffer,new Float32Array(t),e)}updateBufferData(e,t,i){let r=0;const s=this._bufferManager.allocate(i,r),o=s.buffer;r=s.offset,null!==o?o.push(this._bufferManager.encoder,e,r,0,t,i):console.error("Memory upper limit.")}_destroyFishResource(){if(this.fishPersBuffer=null,this.fishPers.length>0&&(this.fishPers.length=0),this._enableDynamicBufferOffset)null!==this.bindGroupFishPers&&null!==this.bindGroupFishPers[0]&&(this.bindGroupFishPers[0]=null);else if(null!==this.bindGroupFishPers)for(let e=0;e<this._preTotalInstance;e++)null!==this.bindGroupFishPers[e]&&(this.bindGroupFishPers[e]=null);this.bindGroupFishPers.length=0,this._bufferManager.destroyBufferPool()}calcConstantBufferByteSize(e){return e+255&-256}}tt.kSwapchainBackBufferUsage=GPUTextureUsage.OUTPUT_ATTACHMENT|GPUTextureUsage.COPY_SRC;class it{constructor(){this._totalTime=1*it.NUM_FRAMES_TO_AVERAGE,this._timeTable=r(it.NUM_FRAMES_TO_AVERAGE,()=>1),this._timeTableCursor=0,this._historyFPS=r(it.NUM_HISTORY_DATA,()=>1),this._historyFrameTime=r(it.NUM_HISTORY_DATA,()=>100),this._logFPS=[],this._averageFPS=0,this._averageFrameTime=0}get averageFPS(){return this._averageFPS}get historyFPS(){return this._historyFPS}get averageFrameTime(){return this._averageFrameTime}get historyFrameTime(){return this._historyFrameTime}update(e,t,i){this._totalTime+=e-this._timeTable[this._timeTableCursor],this._timeTable[this._timeTableCursor]=e,this._timeTableCursor++,this._timeTableCursor===it.NUM_FRAMES_TO_AVERAGE&&(this._timeTableCursor=0),this._averageFPS=Math.floor(1/(this._totalTime/(1*it.NUM_FRAMES_TO_AVERAGE))+.5);for(let e=0;e<it.NUM_HISTORY_DATA;++e)this._historyFPS[e]=this._historyFPS[e+1],this._historyFrameTime[e]=this._historyFrameTime[e+1];this._historyFPS[it.NUM_HISTORY_DATA-1]=this._averageFPS,this._historyFrameTime[it.NUM_HISTORY_DATA-1]=1e3/this._averageFPS,this._averageFrameTime=this._historyFrameTime[it.NUM_HISTORY_DATA-1],i-t>5&&i-t<25&&this._logFPS.push(this._averageFPS)}variance(){let e=0;for(let t=0;t<this._logFPS.length;++t)e+=this._logFPS[t];e/=this._logFPS.length;let t=0;for(let i=0;i<this._logFPS.length;i++)t+=Math.pow(this._logFPS[i]-e,2);return t/=this._logFPS.length,t<it.FPS_VALID_THRESHOLD?Math.ceil(e):0}}it.NUM_HISTORY_DATA=100,it.NUM_FRAMES_TO_AVERAGE=128,it.FPS_VALID_THRESHOLD=5;class rt{static mulMatrixMatrix4(e,t,i){const r=t[0],s=t[1],o=t[2],n=t[3],a=t[4],u=t[5],h=t[6],l=t[7],f=t[8],c=t[9],d=t[10],p=t[11],_=t[12],m=t[13],g=t[14],b=t[15],x=i[0],S=i[1],y=i[2],v=i[3],A=i[4],B=i[5],E=i[6],P=i[7],D=i[8],w=i[9],M=i[10],L=i[11],U=i[12],C=i[13],T=i[14],G=i[15];e[0]=r*x+s*A+o*D+n*U,e[1]=r*S+s*B+o*w+n*C,e[2]=r*y+s*E+o*M+n*T,e[3]=r*v+s*P+o*L+n*G,e[4]=a*x+u*A+h*D+l*U,e[5]=a*S+u*B+h*w+l*C,e[6]=a*y+u*E+h*M+l*T,e[7]=a*v+u*P+h*L+l*G,e[8]=f*x+c*A+d*D+p*U,e[9]=f*S+c*B+d*w+p*C,e[10]=f*y+c*E+d*M+p*T,e[11]=f*v+c*P+d*L+p*G,e[12]=_*x+m*A+g*D+b*U,e[13]=_*S+m*B+g*w+b*C,e[14]=_*y+m*E+g*M+b*T,e[15]=_*v+m*P+g*L+b*G}static inverse4(e,t){const i=t[0],r=t[1],s=t[2],o=t[3],n=t[4],a=t[5],u=t[6],h=t[7],l=t[8],f=t[9],c=t[10],d=t[11],p=t[12],_=t[13],m=t[14],g=t[15],b=c*g,x=m*d,S=u*g,y=m*h,v=u*d,A=c*h,B=s*g,E=m*o,P=s*d,D=c*o,w=s*h,M=u*o,L=l*_,U=p*f,C=n*_,T=p*a,G=n*f,F=l*a,O=i*_,N=p*r,R=i*f,I=l*r,k=i*a,V=n*r,W=b*a+y*f+v*_-(x*a+S*f+A*_),H=x*r+B*f+D*_-(b*r+E*f+P*_),z=S*r+E*a+w*_-(y*r+B*a+M*_),j=A*r+P*a+M*f-(v*r+D*a+w*f),Y=1/(i*W+n*H+l*z+p*j);e[0]=Y*W,e[1]=Y*H,e[2]=Y*z,e[3]=Y*j,e[4]=Y*(x*n+S*l+A*p-(b*n+y*l+v*p)),e[5]=Y*(b*i+E*l+P*p-(x*i+B*l+D*p)),e[6]=Y*(y*i+B*n+M*p-(S*i+E*n+w*p)),e[7]=Y*(v*i+D*n+w*l-(A*i+P*n+M*l)),e[8]=Y*(L*h+T*d+G*g-(U*h+C*d+F*g)),e[9]=Y*(U*o+O*d+I*g-(L*o+N*d+R*g)),e[10]=Y*(C*o+N*h+k*g-(T*o+O*h+V*g)),e[11]=Y*(F*o+R*h+V*d-(G*o+I*h+k*d)),e[12]=Y*(C*c+F*m+U*u-(G*m+L*u+T*c)),e[13]=Y*(R*m+L*s+N*c-(O*c+I*m+U*s)),e[14]=Y*(O*u+V*m+T*s-(k*m+C*s+N*u)),e[15]=Y*(k*c+G*s+I*u-(R*u+V*c+F*s))}static transpose4(e,t){const i=t[0],r=t[1],s=t[2],o=t[3],n=t[4],a=t[5],u=t[6],h=t[7],l=t[8],f=t[9],c=t[10],d=t[11],p=t[12],_=t[13],m=t[14],g=t[15];e[0]=i,e[1]=n,e[2]=l,e[3]=p,e[4]=r,e[5]=a,e[6]=f,e[7]=_,e[8]=s,e[9]=u,e[10]=c,e[11]=m,e[12]=o,e[13]=h,e[14]=d,e[15]=g}static frustum(e,t,i,r,s,o,n){const a=i-t,u=s-r,h=o-n;e[0]=2*o/a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*o/u,e[6]=0,e[7]=0,e[8]=(t+i)/a,e[9]=(s+r)/u,e[10]=n/h,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*n/h,e[15]=0}static getAxis(e,t,i){const r=4*i;e[0]=t[r+0],e[1]=t[r+1],e[2]=t[r+2]}static mulScalarVector(e,t,i){for(let r=0;r<i;++r)t[r]=t[r]*e}static addVector(e,t,i,r){for(let s=0;s<r;++s)e[s]=t[s]+i[s]}static normalize(e,t,i){let r=0;for(let e=0;e<i;++e)r+=t[e]*t[e];if(r=Math.sqrt(r),r>1e-5)for(let s=0;s<i;++s)e[s]=t[s]/r;else for(let t=0;t<i;++t)e[t]=0}static subVector(e,t,i,r){for(let s=0;s<r;++s)e[s]=t[s]-i[s]}static cross(e,t,i){e[0]=t[1]*i[2]-t[2]*i[1],e[1]=t[2]*i[0]-t[0]*i[2],e[2]=t[0]*i[1]-t[1]*i[0]}static dot(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}static cameraLookAt(e,t,i,r){let s=new Float32Array(3),o=new Float32Array(3),n=new Float32Array(3);rt.subVector(s,t,i,3),rt.normalize(s,s,3),rt.cross(o,r,s),rt.normalize(o,o,3),rt.cross(n,s,o),e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=0,e[4]=n[0],e[5]=n[1],e[6]=n[2],e[7]=0,e[8]=s[0],e[9]=s[1],e[10]=s[2],e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1}static resetPseudoRandom(){rt._randomSeed=0}static pseudoRandom(){return rt._randomSeed=(134775813*rt._randomSeed+1)%rt._RANDOM_RANGE,rt._randomSeed/rt._randomSeed}static translation(e,t){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1}static translate(e,t){const i=t[0],r=t[1],s=t[2],o=e[0],n=e[1],a=e[2],u=e[3],h=e[4],l=e[5],f=e[6],c=e[7],d=e[8],p=e[9],_=e[10],m=e[11],g=e[12],b=e[13],x=e[14],S=e[15];e[12]=o*i+h*r+d*s+g,e[13]=n*i+l*r+p*s+b,e[14]=a*i+f*r+_*s+x,e[15]=u*i+c*r+m*s+S}static degToRad(e){return e*Math.PI/180}}rt._RANDOM_RANGE=4294967296,rt._randomSeed=0;var st,ot,nt,at,ut=function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function n(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,a)}u((r=r.apply(e,t||[])).next())}))};!function(e){e[e.MODELFIRST=0]="MODELFIRST",e[e.MODELRUINCOlOMN=1]="MODELRUINCOlOMN",e[e.MODELARCH=2]="MODELARCH",e[e.MODELROCKA=3]="MODELROCKA",e[e.MODELROCKB=4]="MODELROCKB",e[e.MODELROCKC=5]="MODELROCKC",e[e.MODELSUNKNSHIPBOXES=6]="MODELSUNKNSHIPBOXES",e[e.MODELSUNKNSHIPDECK=7]="MODELSUNKNSHIPDECK",e[e.MODELSUNKNSHIPHULL=8]="MODELSUNKNSHIPHULL",e[e.MODELFLOORBASE_BAKED=9]="MODELFLOORBASE_BAKED",e[e.MODELSUNKNSUB=10]="MODELSUNKNSUB",e[e.MODELCORAL=11]="MODELCORAL",e[e.MODELSTONE=12]="MODELSTONE",e[e.MODELCORALSTONEA=13]="MODELCORALSTONEA",e[e.MODELCORALSTONEB=14]="MODELCORALSTONEB",e[e.MODELGLOBEBASE=15]="MODELGLOBEBASE",e[e.MODELTREASURECHEST=16]="MODELTREASURECHEST",e[e.MODELENVIRONMENTBOX=17]="MODELENVIRONMENTBOX",e[e.MODELSUPPORTBEAMS=18]="MODELSUPPORTBEAMS",e[e.MODELSKYBOX=19]="MODELSKYBOX",e[e.MODELGLOBEINNER=20]="MODELGLOBEINNER",e[e.MODELSEAWEEDA=21]="MODELSEAWEEDA",e[e.MODELSEAWEEDB=22]="MODELSEAWEEDB",e[e.MODELSMALLFISHA=23]="MODELSMALLFISHA",e[e.MODELMEDIUMFISHA=24]="MODELMEDIUMFISHA",e[e.MODELMEDIUMFISHB=25]="MODELMEDIUMFISHB",e[e.MODELBIGFISHA=26]="MODELBIGFISHA",e[e.MODELBIGFISHB=27]="MODELBIGFISHB",e[e.MODELSMALLFISHAINSTANCEDDRAWS=28]="MODELSMALLFISHAINSTANCEDDRAWS",e[e.MODELMEDIUMFISHAINSTANCEDDRAWS=29]="MODELMEDIUMFISHAINSTANCEDDRAWS",e[e.MODELMEDIUMFISHBINSTANCEDDRAWS=30]="MODELMEDIUMFISHBINSTANCEDDRAWS",e[e.MODELBIGFISHAINSTANCEDDRAWS=31]="MODELBIGFISHAINSTANCEDDRAWS",e[e.MODELBIGFISHBINSTANCEDDRAWS=32]="MODELBIGFISHBINSTANCEDDRAWS",e[e.MODELMAX=33]="MODELMAX"}(st||(st={})),function(e){e[e.FISH=0]="FISH",e[e.FISHINSTANCEDDRAW=1]="FISHINSTANCEDDRAW",e[e.INNER=2]="INNER",e[e.SEAWEED=3]="SEAWEED",e[e.GENERIC=4]="GENERIC",e[e.OUTSIDE=5]="OUTSIDE",e[e.GROUPMAX=6]="GROUPMAX"}(ot||(ot={}));!function(e){e[e.BIG=0]="BIG",e[e.MEDIUM=1]="MEDIUM",e[e.SMALL=2]="SMALL",e[e.MAX=3]="MAX"}(nt||(nt={})),function(e){e[e.AUTOSTOP=0]="AUTOSTOP",e[e.ENABLEALPHABLENDING=1]="ENABLEALPHABLENDING",e[e.ENABLEMSAAx4=2]="ENABLEMSAAx4",e[e.ENABLEINSTANCEDDRAWS=3]="ENABLEINSTANCEDDRAWS",e[e.ENABLEDYNAMICBUFFEROFFSET=4]="ENABLEDYNAMICBUFFEROFFSET",e[e.DISABLED3D12RENDERPASS=5]="DISABLED3D12RENDERPASS",e[e.DISABLEWEBGPUVALIDATION=6]="DISABLEWEBGPUVALIDATION",e[e.DISABLECONTROLPANEL=7]="DISABLECONTROLPANEL",e[e.INTEGRATEDGPU=8]="INTEGRATEDGPU",e[e.DISCRETEGPU=9]="DISCRETEGPU",e[e.UPATEANDDRAWFOREACHMODEL=10]="UPATEANDDRAWFOREACHMODEL",e[e.ENABLEFULLSCREENMODE=11]="ENABLEFULLSCREENMODE",e[e.PRINTLOG=12]="PRINTLOG",e[e.BUFFERMAPPINGASYNC=13]="BUFFERMAPPINGASYNC",e[e.SIMULATINGFISHCOMEANDGO=14]="SIMULATINGFISHCOMEANDGO",e[e.TURNOFFVSYNC=15]="TURNOFFVSYNC",e[e.TOGGLEMAX=16]="TOGGLEMAX"}(at||(at={}));const ht=[{namestr:"SmallFishA",name:st.MODELSMALLFISHA,program:["fishVertexShader","fishReflectionFragmentShader"],fog:!0,type:ot.FISH},{namestr:"MediumFishA",name:st.MODELMEDIUMFISHA,program:["fishVertexShader","fishNormalMapFragmentShader"],fog:!0,type:ot.FISH},{namestr:"MediumFishB",name:st.MODELMEDIUMFISHB,program:["fishVertexShader","fishReflectionFragmentShader"],fog:!0,type:ot.FISH},{namestr:"BigFishA",name:st.MODELBIGFISHA,program:["fishVertexShader","fishNormalMapFragmentShader"],fog:!0,type:ot.FISH},{namestr:"BigFishB",name:st.MODELBIGFISHB,program:["fishVertexShader","fishNormalMapFragmentShader"],fog:!0,type:ot.FISH},{namestr:"SmallFishA",name:st.MODELSMALLFISHAINSTANCEDDRAWS,program:["fishVertexShaderInstancedDraws","fishReflectionFragmentShader"],fog:!0,type:ot.FISHINSTANCEDDRAW},{namestr:"MediumFishA",name:st.MODELMEDIUMFISHAINSTANCEDDRAWS,program:["fishVertexShaderInstancedDraws","fishNormalMapFragmentShader"],fog:!0,type:ot.FISHINSTANCEDDRAW},{namestr:"MediumFishB",name:st.MODELMEDIUMFISHBINSTANCEDDRAWS,program:["fishVertexShaderInstancedDraws","fishReflectionFragmentShader"],fog:!0,type:ot.FISHINSTANCEDDRAW},{namestr:"BigFishA",name:st.MODELBIGFISHAINSTANCEDDRAWS,program:["fishVertexShaderInstancedDraws","fishNormalMapFragmentShader"],fog:!0,type:ot.FISHINSTANCEDDRAW},{namestr:"BigFishB",name:st.MODELBIGFISHBINSTANCEDDRAWS,program:["fishVertexShaderInstancedDraws","fishNormalMapFragmentShader"],fog:!0,type:ot.FISHINSTANCEDDRAW},{namestr:"Arch",name:st.MODELARCH,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"Coral",name:st.MODELCORAL,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"CoralStoneA",name:st.MODELCORALSTONEA,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"CoralStoneB",name:st.MODELCORALSTONEB,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"EnvironmentBox",name:st.MODELENVIRONMENTBOX,program:["diffuseVertexShader","diffuseFragmentShader"],fog:!1,type:ot.OUTSIDE},{namestr:"FloorBase_Baked",name:st.MODELFLOORBASE_BAKED,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"GlobeBase",name:st.MODELGLOBEBASE,program:["diffuseVertexShader","diffuseFragmentShader"],fog:!1,type:ot.GENERIC},{namestr:"GlobeInner",name:st.MODELGLOBEINNER,program:["innerRefractionMapVertexShader","innerRefractionMapFragmentShader"],fog:!0,type:ot.INNER},{namestr:"RockA",name:st.MODELROCKA,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"RockB",name:st.MODELROCKB,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"RockC",name:st.MODELROCKC,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"RuinColumn",name:st.MODELRUINCOlOMN,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"Stone",name:st.MODELSTONE,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"SunknShipBoxes",name:st.MODELSUNKNSHIPBOXES,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"SunknShipDeck",name:st.MODELSUNKNSHIPDECK,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"SunknShipHull",name:st.MODELSUNKNSHIPHULL,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"SunknSub",name:st.MODELSUNKNSUB,program:["",""],fog:!0,type:ot.GENERIC},{namestr:"SeaweedA",name:st.MODELSEAWEEDA,program:["seaweedVertexShader","seaweedFragmentShader"],fog:!1,type:ot.SEAWEED},{namestr:"SeaweedB",name:st.MODELSEAWEEDB,program:["seaweedVertexShader","seaweedFragmentShader"],fog:!1,type:ot.SEAWEED},{namestr:"Skybox",name:st.MODELSKYBOX,program:["diffuseVertexShader","diffuseFragmentShader"],fog:!1,type:ot.OUTSIDE},{namestr:"SupportBeams",name:st.MODELSUPPORTBEAMS,program:["",""],fog:!1,type:ot.OUTSIDE},{namestr:"TreasureChest",name:st.MODELTREASURECHEST,program:["",""],fog:!0,type:ot.GENERIC}],lt=[{name:"SmallFishA",modelName:st.MODELSMALLFISHA,type:nt.SMALL,speed:1,speedRange:1.5,radius:30,radiusRange:25,tailSpeed:10,heightOffset:0,heightRange:16,fishLength:10,fishWaveLength:1,fishBendAmount:2},{name:"MediumFishA",modelName:st.MODELMEDIUMFISHA,type:nt.MEDIUM,speed:1,speedRange:2,radius:10,radiusRange:20,tailSpeed:1,heightOffset:0,heightRange:16,fishLength:10,fishWaveLength:-2,fishBendAmount:2},{name:"MediumFishB",modelName:st.MODELMEDIUMFISHB,type:nt.MEDIUM,speed:.5,speedRange:4,radius:10,radiusRange:20,tailSpeed:3,heightOffset:-8,heightRange:5,fishLength:10,fishWaveLength:-2,fishBendAmount:2},{name:"BigFishA",modelName:st.MODELBIGFISHA,type:nt.BIG,speed:.5,speedRange:.5,radius:50,radiusRange:3,tailSpeed:1.5,heightOffset:0,heightRange:16,fishLength:10,fishWaveLength:-1,fishBendAmount:.5,lasers:!0,laserRot:.04,laserOff:[0,.1,9],laserScale:[.3,.3,1e3]},{name:"BigFishB",modelName:st.MODELBIGFISHB,type:nt.BIG,speed:.5,speedRange:.5,radius:45,radiusRange:3,tailSpeed:1,heightOffset:0,heightRange:16,fishLength:10,fishWaveLength:-.7,fishBendAmount:.3,lasers:!0,laserRot:.04,laserOff:[0,-.3,9],laserScale:[.3,.3,1e3]}],ft=(Math.PI,Math.PI,[0,0,0]);class ct{constructor(){this.projection=r(16,()=>0),this.view=r(16,()=>0),this.worldInverse=r(16,()=>0),this.viewProjectionInverse=r(16,()=>0),this.skyView=r(16,()=>0),this.skyViewProjection=r(16,()=>0),this.skyViewProjectionInverse=r(16,()=>0),this.eyePosition=r(3,()=>0),this.target=r(3,()=>0),this.up=[0,1,0],this.v3t0=r(3,()=>0),this.v3t1=r(3,()=>0),this.m4t0=r(16,()=>0),this.m4t1=r(16,()=>0),this.m4t2=r(16,()=>0),this.m4t3=r(16,()=>0),this.colorMult=[1,1,1,1]}}class dt{constructor(){this.lightWorldPositionUniform=new Pe,this.worldUniforms=new we,this.lightUniforms=new Ee,this.fogUniforms=new ve,this.g=new ct,this._modelEnumMap={},this._textureMap={},this._programMap={},this._context=null,this._fpsTimer=null,this._curFishCount=1,this._preFishCount=0,this.g.then=0,this.g.mclock=0,this.g.eyeClock=0,this.g.alpha="1",this.lightUniforms.ambient=[.218,.502,.706,0],this.lightUniforms.lightColor=[1,1,1,1],this.lightUniforms.specular=[1,1,1,1],this.fogUniforms.fogColor=[.338,.81,1,1],this.fogUniforms.fogPower=16.5,this.fogUniforms.fogMult=1.5,this.fogUniforms.fogOffset=.738,this.fishCount=[0,0,0,0,0],this.toggleBitset=r(at.TOGGLEMAX,()=>!1),this._aquariumModels=r(st.MODELMAX,()=>null),this._fpsTimer=new it,this._fisCountGetter=()=>this.curFishCount,this._fisCountSetter=e=>{this.curFishCount=e}}dispose(){}get skybox(){return this._textureMap.skybox}get curFishCount(){return this._curFishCount}set curFishCount(e){}get preFishCount(){return this._preFishCount}init(e){return ut(this,void 0,void 0,(function*(){return Promise.resolve().then(()=>ut(this,void 0,void 0,(function*(){this._context=new tt;const t=this._context.availableToggleBitset;if(t[at.UPATEANDDRAWFOREACHMODEL]&&(this.toggleBitset[at.UPATEANDDRAWFOREACHMODEL]=!0),t[at.ENABLEDYNAMICBUFFEROFFSET]&&(this.toggleBitset[at.ENABLEDYNAMICBUFFEROFFSET]=!0),this.toggleBitset[at.ENABLEALPHABLENDING]=!0,!this._processOptions(e,t))return!1;if(!(yield this._context.initialize(this.toggleBitset,e.canvas)))return!1;this._calculateFishCount(),console.log("Init resources ..."),this._getElapsedTime();const i=this._context.resourceHelper.getSkyBoxUrls();return this._textureMap.skybox=yield this._context.createTextureWebGPU("skybox",i),this._context.initGeneralResources(this),this._preFishCount=this._curFishCount,this._setupModelEnumMap(),yield this.loadResource(),this._context.flush(),console.log("End loading.\nCost "+this._getElapsedTime()+"s totally."),this._resetFpsTime(),!0})))}))}_processOptions(e,t){if(!e)return!1;if(e.num_fish&&(this._curFishCount=e.num_fish,this._curFishCount<0))return console.error("Fish count should larger or equal to 0."),!1;if(e.enable_msaa){if(!t[at.ENABLEMSAAx4])return console.error("MSAA isn't implemented for the backend."),!1;this.toggleBitset[at.ENABLEMSAAx4]=!0}if(e.disable_dynamic_buffer_offset){if(!t[at.ENABLEDYNAMICBUFFEROFFSET])return console.error("Dynamic buffer offset is not supported."),!1;this.toggleBitset[at.ENABLEDYNAMICBUFFEROFFSET]=!0}if(e.integrated_gpu){if(!t[at.INTEGRATEDGPU]&&!t[at.DISCRETEGPU])return console.error("Dynamically choose gpu isn't supported for the backend."),!1;t[at.DISCRETEGPU]&&console.error("Integrated and Discrete gpu cannot be used simultaneosly."),this.toggleBitset[at.INTEGRATEDGPU]=!0}if(e.discrete_gpu){if(!t[at.INTEGRATEDGPU]&&!t[at.DISCRETEGPU])return console.error("Dynamically choose gpu isn't supported for the backend."),!1;t[at.INTEGRATEDGPU]&&console.error("Integrated and Discrete gpu cannot be used simultaneosly."),this.toggleBitset[at.DISCRETEGPU]=!0}if(e.enable_full_screen_mode){if(!t[at.ENABLEFULLSCREENMODE])return console.error("Full screen mode isn't supported for the backend."),!1;this.toggleBitset[at.ENABLEFULLSCREENMODE]=!0}if(e.print_log&&(this.toggleBitset[at.PRINTLOG]=!0),e.buffer_mapping_async){if(!t[at.BUFFERMAPPINGASYNC])return console.error("Buffer mapping async isn't supported for the backend."),!1;this.toggleBitset[at.BUFFERMAPPINGASYNC]=!0}if(e.turn_off_vsync){if(!t[at.TURNOFFVSYNC])return console.error("Turn off vsync isn't supported for the backend."),!1;this.toggleBitset[at.TURNOFFVSYNC]=!0}if(e.test_time&&(this._testTime=e.test_time,this.toggleBitset[at.AUTOSTOP]=!0),e.disable_webgpu_validation){if(!t[at.DISABLEWEBGPUVALIDATION])return console.error("Disable validation for WebGPU backend."),!1;this.toggleBitset[at.DISABLEWEBGPUVALIDATION]=!0}if(e.enable_alpha_blending&&(this.g.alpha=e.enable_alpha_blending,"false"===this.g.alpha&&(this.toggleBitset[at.ENABLEALPHABLENDING]=!1)),e.simulating_fish_come_and_go){if(!t[at.SIMULATINGFISHCOMEANDGO])return console.error("Simulating fish come and go is only implemented for WebGPU backend."),!1;this.toggleBitset[at.SIMULATINGFISHCOMEANDGO]=!0}return e.disable_control_panel&&(this.toggleBitset[at.DISABLECONTROLPANEL]=!0),!0}_resetFpsTime(){this.g.start=performance.now()/1e3,this.g.then=this.g.start}display(){let e=this._context.shouldQuit();e||(this._context.statsBegin(),this._context.keyBoardQuit(),this._render(),this._context.doFlush(this.toggleBitset),this.toggleBitset[at.AUTOSTOP]&&this.g.then-this.g.start>this._testTime&&(e=!0),this._context.statsEnd()),e?(this._context.terminate(),this.toggleBitset[at.PRINTLOG]&&this._printAvgFps()):window.requestAnimationFrame(this.display.bind(this))}loadResource(){return ut(this,void 0,void 0,(function*(){return Promise.resolve().then(()=>ut(this,void 0,void 0,(function*(){yield this._loadModels(),yield this._loadPlacement(),this.toggleBitset[at.SIMULATINGFISHCOMEANDGO]&&(yield this._loadFishScenario())})))}))}_setupModelEnumMap(){for(let e of ht)this._modelEnumMap[e.namestr]=e.name}_loadPlacement(){return ut(this,void 0,void 0,(function*(){const e=this._context.resourceHelper.propPlacementPath;return new Promise((t,i)=>{We.LoadJSON(e,(e,r)=>{r&&(console.error("Unable to load placement file: "+r),i(r)),s("objects"in e,"JSON file does not contain an 'objects' key.");let o=e.objects;s(Array.isArray(o),"'objects' value is not an array.");for(let e=0;e<o.length;++e){const t=o[e].name,i=o[e].worldMatrix;s(Array.isArray(i)&&16==i.length,"Invalid world matrix");let r=[];for(let e=0;e<i.length;++e)r.push(i[e]);const n=this._modelEnumMap[t];n!==st.MODELFIRST&&this._aquariumModels[n]&&this._aquariumModels[n].worldmatrices.push(r)}t()})})}))}_loadModels(){return ut(this,void 0,void 0,(function*(){return Promise.resolve().then(()=>ut(this,void 0,void 0,(function*(){const e=this.toggleBitset[at.ENABLEINSTANCEDDRAWS];for(let t of ht)e&&t.type===ot.FISH||!e&&t.type===ot.FISHINSTANCEDDRAW||(yield this._loadModel(t))})))}))}_loadFishScenario(){return ut(this,void 0,void 0,(function*(){const e=this._context.resourceHelper.fishBehaviorPath;return new Promise((t,i)=>{We.LoadJSON(e,(e,r)=>{r&&(console.error("Unable to load fish scenario file: "+r),i(r)),s("behaviors"in e,"JSON file does not contain a 'behaviors' key.");let n=e.behaviors;s(Array.isArray(n),"'behaviors' value is not an array.");for(let e=0;e<n.length;++e){const t=n[e].frame,i=n[e].op,r=n[e].count,s=new o(t,i,r);this._fishBehavior.push(s)}t()})})}))}_loadModel(e){return ut(this,void 0,void 0,(function*(){const t=this._context.resourceHelper,i=t.imagePath,r=t.programPath,o=t.getModelPath(e.namestr);return new Promise((t,n)=>ut(this,void 0,void 0,(function*(){We.LoadJSON(o,(o,a)=>ut(this,void 0,void 0,(function*(){a&&(console.error("Unable to load model file: "+a),n(a)),s("models"in o,"JSON file does not contain a 'models' key.");let u=o.models;s(Array.isArray(u),"'models' value is not an array.");let h=null;h=this.toggleBitset[at.ENABLEALPHABLENDING]&&e.type!==ot.INNER&&e.type!==ot.OUTSIDE?this._context.createModel(this,e.type,e.name,!0):this._context.createModel(this,e.type,e.name,e.blend),this._aquariumModels[e.name]=h;let l=u[u.length-1];{const t=l.textures;for(let e in t){const r=e,s=t[e];s in this._textureMap||(this._textureMap[s]=yield this._context.createTextureWebGPU(r,i+s)),h.textureMap[r]=this._textureMap[s]}const o=l.fields;for(let e in o){const t=o[e],i=e,r=t.numComponents,n=t.type;let a=null;if("indices"==i){s("Uint16Array"===n,"Invalid indices array type.");let e=[];for(let i of t.data)e.push(i);a=this._context.createBufferWebGPU(r,new Uint16Array(e),!0)}else{s("Float32Array"===n,"Invalid vertices array type.");let e=[];for(let i of t.data)e.push(i);a=this._context.createBufferWebGPU(r,new Float32Array(e),!1)}h.bufferMap[i]=a}let n=e.program[0],a=e.program[1];""!==n&&""!==a?h.textureMap.skybox=this._textureMap.skybox:"reflection"in h.textureMap&&null!==h.textureMap.reflection?(n="reflectionMapVertexShader",a="reflectionMapFragmentShader",h.textureMap.skybox=this._textureMap.skybox):"normalMap"in h.textureMap&&null!==h.textureMap.normalMap?(n="normalMapVertexShader",a="normalMapFragmentShader"):(n="diffuseVertexShader",a="diffuseFragmentShader");let u=null;const f=n+a;f in this._programMap?u=this._programMap[f]:(u=this._context.createProgram(r+n,r+a),this.toggleBitset[at.ENABLEALPHABLENDING]&&e.type!==ot.INNER&&e.type!==ot.OUTSIDE?yield u.compileProgram(!0,this.g.alpha):yield u.compileProgram(!1,this.g.alpha),this._programMap[f]=u),h.program=u,h.init()}t()})))})))}))}_calculateFishCount(){let e=this._curFishCount;for(let t=0;t<nt.MAX;++t)for(let i=0;i<lt.length;++i){const r=lt[i];if(r.type!=t)continue;let s=e;if(t==nt.BIG){let t=this._curFishCount<100?1:2;s=Math.min(e,t)}else t===nt.MEDIUM&&(s=this._curFishCount<1e3?Math.min(e,this._curFishCount/10):this._curFishCount<1e4?Math.min(e,80):Math.min(e,160));e-=s,this.fishCount[r.modelName-st.MODELSMALLFISHA]=s}}_getElapsedTime(){const e=performance.now()/1e3;let t=0;return t=0==this.g.then?0:e-this.g.then,this.g.then=e,t}_printAvgFps(){const e=this._fpsTimer.variance();console.log("Avg FPS: "+e),0==e&&console.log("Invalid value. The fps is unstable.")}_updateGlobalUniforms(){let e=this.g,t=this.lightWorldPositionUniform,i=this._getElapsedTime(),r=e.then-e.start;this._fpsTimer.update(i,r,this._testTime),e.mclock+=1*i,e.eyeClock+=.0258*i,e.eyePosition[0]=13.2*Math.sin(e.eyeClock),e.eyePosition[1]=7.5,e.eyePosition[2]=13.2*Math.cos(e.eyeClock),e.target[0]=91.6*Math.sin(e.eyeClock+Math.PI),e.target[1]=63.3,e.target[2]=91.6*Math.cos(e.eyeClock+Math.PI);let s=1*this._context.clientWidth/(1*this._context.clientHeight),o=1*Math.tan(.5*rt.degToRad(82.699)),n=-o,a=s*n,u=s*o,h=Math.abs(u-a),l=Math.abs(o-n),f=h*ft[0]*1.21,c=l*ft[1]*1.21;rt.frustum(e.projection,a+f,u+f,n+c,o+c,1,25e3),rt.cameraLookAt(t.viewInverse,e.eyePosition,e.target,e.up),rt.inverse4(e.view,t.viewInverse),rt.mulMatrixMatrix4(t.viewProjection,e.view,e.projection),rt.inverse4(e.viewProjectionInverse,t.viewProjection),e.skyView[12]=0,e.skyView[13]=0,e.skyView[14]=0,rt.mulMatrixMatrix4(e.skyViewProjection,e.skyView,e.projection),rt.inverse4(e.skyViewProjectionInverse,e.skyViewProjection),rt.getAxis(e.v3t0,t.viewInverse,0),rt.getAxis(e.v3t1,t.viewInverse,1),rt.mulScalarVector(20,e.v3t0,3),rt.mulScalarVector(30,e.v3t1,3),rt.addVector(t.lightWorldPos,e.eyePosition,e.v3t0,3),rt.addVector(t.lightWorldPos,t.lightWorldPos,e.v3t1,3),this._context.updateWorldlUniforms(this)}_render(){if(rt.resetPseudoRandom(),this._context.preFrame(),this._updateGlobalUniforms(),this.toggleBitset[at.SIMULATINGFISHCOMEANDGO]&&this._fishBehavior.length>0){const e=this._fishBehavior[0];let t=e.frame;0==t?(this._fishBehavior.shift(),"+"===e.op?this._curFishCount+=e.count:this._curFishCount-=e.count,console.log("Fish count "+this._curFishCount)):e.frame=--t}if(!this.toggleBitset[at.ENABLEINSTANCEDDRAWS]&&this.curFishCount!=this.preFishCount){this._calculateFishCount();const e=this.toggleBitset[at.ENABLEDYNAMICBUFFEROFFSET];this._context.reallocResource(this.preFishCount,this.curFishCount,e),this._preFishCount=this.curFishCount,this._resetFpsTime()}this.toggleBitset[at.UPATEANDDRAWFOREACHMODEL]?(this._updateAndDrawBackground(),this._updateAndDrawFishes(),this._context.updateFPS(this._fpsTimer,this._fisCountGetter,this._fisCountSetter,this.toggleBitset)):(this._updateBackground(),this._updateFishes(),this._context.updateFPS(this._fpsTimer,this._fisCountGetter,this._fisCountSetter,this.toggleBitset),this._context.beginRenderPass(),this._drawBackground(),this._drawFishes(),this._context.showFPS())}_updateAndDrawBackground(){for(let e=st.MODELRUINCOlOMN;e<=st.MODELSEAWEEDB;++e){const t=this._aquariumModels[e];t&&this._updateWorldMatrixAndDraw(t)}}_drawBackground(){for(let e=st.MODELRUINCOlOMN;e<=st.MODELSEAWEEDB;++e){const t=this._aquariumModels[e];t&&t.draw()}}_updateAndDrawFishes(){const e=this.toggleBitset[at.ENABLEINSTANCEDDRAWS]?st.MODELSMALLFISHAINSTANCEDDRAWS:st.MODELSMALLFISHA,t=this.toggleBitset[at.ENABLEINSTANCEDDRAWS]?st.MODELBIGFISHBINSTANCEDDRAWS:st.MODELBIGFISHB;for(let i=e;i<=t;++i){const t=this._aquariumModels[i];if(!t)continue;const r=lt[i-e],s=this.fishCount[i-e];t.prepareForDraw();const o=.124*this.g.mclock,n=r.radius,a=r.radiusRange,u=r.speed,h=r.speedRange,l=1*r.tailSpeed,f=.52,c=25+r.heightOffset,d=1*r.heightRange,p=1,_=.556,m=1;for(let e=0;e<s;++e){const i=o+e*f,r=u+1*rt.pseudoRandom()*h,s=1+1*rt.pseudoRandom(),g=n+1*rt.pseudoRandom()*a,b=2+1*rt.pseudoRandom()*d,x=n+1*rt.pseudoRandom()*a,S=i*r,y=S*p,v=S*_,A=S*m;t.updateFishPerUniforms(Math.sin(y)*g,Math.sin(v)*b+c,Math.cos(A)*x,Math.sin(y-.04)*g,Math.sin(v-.01)*b+c,Math.cos(A-.04)*x,s,(this.g.mclock+1*e)*l*r%(2*Math.PI),e),t.updatePerInstanceUniforms(this.worldUniforms),t.draw()}}}_updateBackground(){for(let e=st.MODELRUINCOlOMN;e<=st.MODELSEAWEEDB;++e){const t=this._aquariumModels[e];t&&this._updateWorldMatrix(t)}}_updateFishes(){const e=this.toggleBitset[at.ENABLEINSTANCEDDRAWS]?st.MODELSMALLFISHAINSTANCEDDRAWS:st.MODELSMALLFISHA,t=this.toggleBitset[at.ENABLEINSTANCEDDRAWS]?st.MODELBIGFISHBINSTANCEDDRAWS:st.MODELBIGFISHB;for(let i=e;i<=t;++i){const t=this._aquariumModels[i];if(!t)continue;const r=lt[i-e],s=this.fishCount[i-e];t.prepareForDraw();const o=.124*this.g.mclock,n=r.radius,a=r.radiusRange,u=r.speed,h=r.speedRange,l=1*r.tailSpeed,f=.52,c=25+r.heightOffset,d=1*r.heightRange,p=1,_=.556,m=1;for(let e=0;e<s;++e){const i=o+e*f,r=u+1*rt.pseudoRandom()*h,s=1+1*rt.pseudoRandom(),g=n+1*rt.pseudoRandom()*a,b=2+1*rt.pseudoRandom()*d,x=n+1*rt.pseudoRandom()*a,S=i*r,y=S*p,v=S*_,A=S*m;t.updateFishPerUniforms(Math.sin(y)*g,Math.sin(v)*b+c,Math.cos(A)*x,Math.sin(y-.04)*g,Math.sin(v-.01)*b+c,Math.cos(A-.04)*x,s,(this.g.mclock+1*e)*l*r%(2*Math.PI),e)}}this._context.updateAllFishData()}_drawFishes(){const e=this.toggleBitset[at.ENABLEINSTANCEDDRAWS]?st.MODELSMALLFISHAINSTANCEDDRAWS:st.MODELSMALLFISHA,t=this.toggleBitset[at.ENABLEINSTANCEDDRAWS]?st.MODELBIGFISHBINSTANCEDDRAWS:st.MODELBIGFISHB;for(let i=e;i<=t;++i){const e=this._aquariumModels[i];e&&e.draw()}}_updateWorldProjections(e){s(16===e.length,"The length of the array should be equal to 16.");for(let t=0;t<16;++t)this.worldUniforms.world[t]=e[t];rt.mulMatrixMatrix4(this.worldUniforms.worldViewProjection,this.worldUniforms.world,this.lightWorldPositionUniform.viewProjection),rt.inverse4(this.g.worldInverse,this.worldUniforms.world),rt.transpose4(this.worldUniforms.worldInverseTranspose,this.g.worldInverse)}_updateWorldMatrixAndDraw(e){if(e.worldmatrices.length>0)for(let t of e.worldmatrices)this._updateWorldProjections(t),e.prepareForDraw(),e.updatePerInstanceUniforms(this.worldUniforms),e.draw()}_updateWorldMatrix(e){if(e.worldmatrices.length>0)for(let t of e.worldmatrices)this._updateWorldProjections(t),e.updatePerInstanceUniforms(this.worldUniforms);e.prepareForDraw()}}var pt=function(e,t,i,r){return new(i||(i=Promise))((function(s,o){function n(e){try{u(r.next(e))}catch(e){o(e)}}function a(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,a)}u((r=r.apply(e,t||[])).next())}))};!function(){pt(this,void 0,void 0,(function*(){const e=document.getElementById("gfx"),t=new dt,i={canvas:e,enable_full_screen_mode:!0,num_fish:50,enable_msaa:!0,buffer_mapping_async:!1,disable_control_panel:!1};t.init(i).then(e=>{e?t.display():console.error("Unable to initialize aquarium!")}).catch(e=>{console.error(e)})}))}()}]);
//# sourceMappingURL=main.js.map